<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content=".NET 中各种混淆（Obfuscation）的含义、原理、实际效果和不同级别的差异（使用 SmartAssembly）" /><meta name="author" content="吕毅" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="长文预警！！！ UWP 程序有 .NET Native 可以将程序集编译为本机代码，逆向的难度会大很多；而基于 .NET Framework 和 .NET Core 的程序却没有 .NET Native 的支持。虽然有 Ngen.exe 可以编译为本机代码，但那只是在用户计算机上编译完后放入了缓存中，而不是在开发者端编译。 于是有很多款混淆工具来帮助混淆基于 .NET 的程序集，使其稍微难以逆向。本文介绍 Smart Assembly 各项混淆参数的作用以及其实际对程序集的影响。" /><meta property="og:description" content="长文预警！！！ UWP 程序有 .NET Native 可以将程序集编译为本机代码，逆向的难度会大很多；而基于 .NET Framework 和 .NET Core 的程序却没有 .NET Native 的支持。虽然有 Ngen.exe 可以编译为本机代码，但那只是在用户计算机上编译完后放入了缓存中，而不是在开发者端编译。 于是有很多款混淆工具来帮助混淆基于 .NET 的程序集，使其稍微难以逆向。本文介绍 Smart Assembly 各项混淆参数的作用以及其实际对程序集的影响。" /><link rel="canonical" href="https://blog.walterlv.com/post/obfuscation-configurations-of-smart-assembly.html" /><meta property="og:url" content="https://blog.walterlv.com/post/obfuscation-configurations-of-smart-assembly.html" /><meta property="og:site_name" content="walterlv" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-20T23:15:01+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content=".NET 中各种混淆（Obfuscation）的含义、原理、实际效果和不同级别的差异（使用 SmartAssembly）" /><meta name="twitter:site" content="@_lvyi_" /><meta name="twitter:creator" content="@吕毅" /> <script type="application/ld+json"> {"datePublished":"2021-12-20T23:15:01+08:00","description":"长文预警！！！ UWP 程序有 .NET Native 可以将程序集编译为本机代码，逆向的难度会大很多；而基于 .NET Framework 和 .NET Core 的程序却没有 .NET Native 的支持。虽然有 Ngen.exe 可以编译为本机代码，但那只是在用户计算机上编译完后放入了缓存中，而不是在开发者端编译。 于是有很多款混淆工具来帮助混淆基于 .NET 的程序集，使其稍微难以逆向。本文介绍 Smart Assembly 各项混淆参数的作用以及其实际对程序集的影响。","dateModified":"2021-12-20T23:15:46+08:00","headline":".NET 中各种混淆（Obfuscation）的含义、原理、实际效果和不同级别的差异（使用 SmartAssembly）","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.walterlv.com/post/obfuscation-configurations-of-smart-assembly.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.walterlv.com/assets/img/logo.png"},"name":"吕毅"},"url":"https://blog.walterlv.com/post/obfuscation-configurations-of-smart-assembly.html","author":{"@type":"Person","name":"吕毅"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>.NET 中各种混淆（Obfuscation）的含义、原理、实际效果和不同级别的差异（使用 SmartAssembly） - walterlv</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="walterlv"><meta name="application-name" content="walterlv"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="page-bluring-bg" style=" background-image: url('/static/posts/2018-08-19-15-14-44.png'); "></div><div id="topbar-wrapper" class="row topbar-down"><div id="topbar" class="col-12 d-flex h-100 align-items-center"><div id="topbar-logoside" class="col"> <a id="topbar-logo" href="https://blog.walterlv.com" alt="avatar"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <a id="topbar-title" class="site-title" href="https://blog.walterlv.com" alt="walterlv"> walterlv </a></div><div id="topbar-searchside" class="justify-content-center col-5"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div><div class="col"></div></div></div><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="sidebar-box post-item-box profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">吕毅</a></div><div class="site-subtitle font-italic">.NET and Windows App Developer, Microsoft MVP</div></div><ul class="sidebar-box post-item-box"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/friends/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>朋友和收藏</span> </a><li class="nav-item"> <a href="/mind/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>胡思乱想</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/walterlv" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_lvyi_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['walter.lv','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>.NET 中各种混淆（Obfuscation）的含义、原理、实际效果和不同级别的差异（使用 SmartAssembly）</h1><div class="post-meta text-muted"><div class="d-flex"> <span> 吕毅 </span> <span> 发表于 <em class="timeago" date="2018-08-19 20:42:42 +0800" data-toggle="tooltip" data-placement="bottom" title="2018-08-19, 20:42 +0800" >2018-08-19</em> </span> <span> 更新于 <em class="timeago" date="2021-12-20 23:15:01 +0800" data-toggle="tooltip" data-placement="bottom" title="2021-12-20, 23:15 +0800" >2021-12-20</em> </span></div></div><div class="post-content"><p>长文预警！！！</p><p>UWP 程序有 .NET Native 可以将程序集编译为本机代码，逆向的难度会大很多；而基于 .NET Framework 和 .NET Core 的程序却没有 .NET Native 的支持。虽然有 Ngen.exe 可以编译为本机代码，但那只是在用户计算机上编译完后放入了缓存中，而不是在开发者端编译。</p><p>于是有很多款混淆工具来帮助混淆基于 .NET 的程序集，使其稍微难以逆向。本文介绍 Smart Assembly 各项混淆参数的作用以及其实际对程序集的影响。</p><hr /><p>本文不会讲 SmartAssembly 的用法，因为你只需打开它就能明白其基本的使用。</p><p>感兴趣可以先下载：<a href="https://www.red-gate.com/products/dotnet-development/smartassembly/index">.NET Obfuscator, Error Reporting, DLL Merging - SmartAssembly</a>。</p><div id="toc"></div><h2 id="准备">准备<a href="#准备"><i class="fas fa-hashtag"></i></a></h2></h2><p>我们先需要准备程序集来进行混淆试验。这里，我使用 <a href="ms-windows-store://pdp/?productid=9P8LNZRNJX85">Whitman</a> 来试验。它在 <a href="https://github.com/walterlv/Whitman">GitHub 上开源</a>，并且有两个程序集可以试验它们之间的相互影响。</p><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-15-14-44.png" alt="准备程序集" /></p><p>额外想吐槽一下，SmartAssembly 的公司 Red Gate 一定不喜欢这款软件，因为界面做成下面这样竟然还长期不更新：</p><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-16-24-01.png" alt="无力吐槽的界面" /></p><p>而且，如果要成功编译，还得用上同为 Red Gate 家出品的 SQL Server，如果不装，软件到处弹窗报错。只是报告错误而已，干嘛还要开发者装一个那么重量级的 SQL Server 啊！详见：<a href="https://forum.red-gate.com/discussion/83290/why-is-sql-server-required">Why is SQL Server required — Redgate forums</a>。</p><h2 id="smartassembly">SmartAssembly<a href="#smartassembly"><i class="fas fa-hashtag"></i></a></h2></h2><p>SmartAssembly 本质上是保护应用程序不被逆向或恶意篡改。目前我使用的版本是 6，它提供了对 .NET Framework 程序的多种保护方式：</p><ul><li><em>强签名 Strong Name Signing</em><ul><li>强签名可以确保程序之间的依赖关系是严格确定的，如果对其中的一个依赖进行篡改，将导致无法加载正确的程序集。<li>微软提供了强签名工具，所以可以无需使用 SmartAssembly 的：<ul><li><a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/sn-exe-strong-name-tool?wt.mc_id=MVP">Sn.exe (Strong Name Tool) - Microsoft Docs</a><li><a href="https://docs.microsoft.com/en-us/dotnet/framework/app-domains/how-to-sign-an-assembly-with-a-strong-name?wt.mc_id=MVP">How to: Sign an Assembly with a Strong Name - Microsoft Docs</a></ul></ul><li><em>自动错误上报 Automated Error Reporting</em><ul><li>SmartAssembly 会自动向 exe 程序注入异常捕获与上报的逻辑。</ul><li><em>功能使用率上报 Feature Usage Reporting</em><ul><li>SmartAssembly 会修改每个方法，记录这些方法的调用次数并上报。</ul><li><em>依赖合并 Dependencies Merging</em><ul><li>SmartAssembly 会将程序集中你勾选的的依赖与此程序集合并成一个整的程序集。</ul><li><em>依赖嵌入 Dependencies Embedding</em><ul><li>SmartAssembly 会将依赖以加密并压缩的方式嵌入到程序集中，运行时进行解压缩与解密。<li>其实这只是方便了部署（一个 exe 就能发给别人），并不能真正保护程序集，因为实际运行时还是解压并解密出来了。</ul><li><em>裁剪 Pruning</em><ul><li>SmartAssembly 会将没有用到的字段、属性、方法、事件等删除。它声称删除了这些就能让程序逆向后代码更难读懂。</ul><li><strong>名称混淆 Obfuscation</strong><ul><li>修改类型、字段、属性、方法等的名称。</ul><li><strong>流程混淆 Control Flow Obfuscation</strong><ul><li>修改方法内的执行逻辑，使其执行错综复杂。</ul><li><strong>动态代理 References Dynamic Proxy</strong><ul><li>SmartAssembly 会将方法的调用转到动态代理上。</ul><li><strong>资源压缩加密 Resources Compression and Encryption</strong><ul><li>SmartAssembly 会将资源以加密并压缩的方式嵌入到程序集中，运行时进行解压缩与解密。</ul><li><strong>字符串压缩加密 Strings Encoding</strong><ul><li>SmartAssembly 会将字符串都进行加密，运行时自动对其进行解密。</ul><li><strong>防止 MSIL Disassembler 对其进行反编译 MSIL Disassembler Protection</strong><ul><li>在程序集中加一个 Attribute，这样 MSIL Disassembler 就不会反编译这个程序集。</ul><li><em>密封类</em><ul><li>如果 SmartAssembly 发现一个类可以被密封，就会把它密封，这样能获得一点点性能提升。</ul><li><em>生成调试信息 Generate Debugging Information</em><ul><li>可以生成混淆后的 pdb 文件</ul></ul><p>以上所有 SmartAssembly 对程序集的修改中，我标为 <strong>粗体</strong> 的是真的在做混淆，而标为 <em>斜体</em> 的是一些辅助功能。</p><p>后面我只会说明其混淆功能。</p><h2 id="裁剪-pruning">裁剪 Pruning<a href="#裁剪-pruning"><i class="fas fa-hashtag"></i></a></h2></h2><p>我故意在 Whitman.Core 中写了一个没有被用到的 <code class="language-plaintext highlighter-rouge">internal</code> 类 <code class="language-plaintext highlighter-rouge">UnusedClass</code>，如果我们开启了裁剪，那么这个类将消失。</p><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-17-10-51.png" alt="消失的类" /><br /> ▲ 没用到的类将消失</p><p>特别注意，如果标记了 <code class="language-plaintext highlighter-rouge">InternalsVisibleTo</code>，尤其注意不要不小心被误删了。</p><h2 id="名称混淆-obfuscation">名称混淆 Obfuscation<a href="#名称混淆-obfuscation"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="类方法名与字段名的混淆">类/方法名与字段名的混淆<a href="#类方法名与字段名的混淆"><i class="fas fa-hashtag"></i></a></h3></h3><p>名称混淆中，类名和方法名的混淆有三个不同级别：</p><ul><li>等级 1 是使用 ASCII 字符集<li>等级 2 是使用不可见的 Unicode 字符集<li>等级 3 是使用高级重命名算法的不可见的 Unicode 字符集</ul><p>需要注意：对于部分程序集，<strong>类与方法名（NameMangling）的等级只能选为 3，否则混淆程序会无法完成编译</strong>。</p><p>字段名的混淆有三个不同级别：</p><ul><li>等级 1 是源码中字段名称和混淆后字段名称一一对应<li>等级 2 是在一个类中的不同字段使用不同名称即可（这不废话吗，不过 SmartAssembly 应该是为了强调与等级 1 和等级 3 的不同，必须写一个描述）<li>等级 3 是允许不同类中的字段使用相同的名字（这样能够更加让人难以理解）</ul><p>需要注意：对于部分程序集，<strong>字段名（FieldsNameMangling）的等级只能选为 2 或 3，否则混淆程序会无法完成编译</strong>。</p><p>实际试验中，以上各种组合经常会出现无法编译的情况。</p><p>下面是 Whitman 中 <code class="language-plaintext highlighter-rouge">RandomIdentifier</code> 类中的部分字段在混淆后的效果：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c1">// Token: 0x04000001 RID: 1</span>
<span class="p">[</span><span class="n">CompilerGenerated</span><span class="p">]</span>
<span class="p">[</span><span class="nf">DebuggerBrowsable</span><span class="p">(</span><span class="n">DebuggerBrowsableState</span><span class="p">.</span><span class="n">Never</span><span class="p">)]</span>
<span class="k">private</span> <span class="kt">int</span> <span class="err">\</span><span class="n">u0001</span><span class="p">;</span>

<span class="c1">// Token: 0x04000002 RID: 2</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">Random</span> <span class="err">\</span><span class="n">u0001</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>

<span class="c1">// Token: 0x04000003 RID: 3</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="err">\</span><span class="n">u0001</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;();</span>
</pre></table></code></div></div><p>这部分的原始代码可以在 <a href="/post/algorithm-of-generating-random-identifiers">冷算法：自动生成代码标识符（类名、方法名、变量名）</a> 找到。</p><p>如果你需要在混淆时使用名称混淆，你只需要在以上两者的组合中找到一个能够编译通过的组合即可，不需要特别在意等级 1~3 的区别，因为实际上都做了混淆，1~3 的差异对逆向来说难度差异非常小的。</p><p>需要 <strong>特别小心如果有 <code class="language-plaintext highlighter-rouge">InternalsVisibleTo</code> 或者依据名称的反射调用，这种混淆下极有可能挂掉</strong>！！！<strong>请充分测试你的软件，切记</strong>！！！</p><h3 id="转移方法-changemethodparent">转移方法 ChangeMethodParent<a href="#转移方法-changemethodparent"><i class="fas fa-hashtag"></i></a></h3></h3><p>如果开启了 ChangeMethodParent，那么混淆可能会将一个类中的方法转移到另一个类中，这使得逆向时对类型含义的解读更加匪夷所思。</p><h3 id="排除特定的命名空间">排除特定的命名空间<a href="#排除特定的命名空间"><i class="fas fa-hashtag"></i></a></h3></h3><p>如果你的程序集中确实存在需要被按照名称反射调用的类型，或者有 <code class="language-plaintext highlighter-rouge">internal</code> 的类/方法需要被友元程序集调用，请排除这些命名空间。</p><h2 id="流程混淆-control-flow-obfuscation">流程混淆 Control Flow Obfuscation<a href="#流程混淆-control-flow-obfuscation"><i class="fas fa-hashtag"></i></a></h2></h2><p>列举我在 Whitman.Core 中的方法：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="kt">string</span> <span class="nf">Generate</span><span class="p">(</span><span class="kt">bool</span> <span class="n">pascal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">wordCount</span> <span class="p">=</span> <span class="n">WordCount</span> <span class="p">&lt;=</span> <span class="m">0</span> <span class="p">?</span> <span class="m">4</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">9</span><span class="p">))</span> <span class="p">:</span> <span class="n">WordCount</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">wordCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">syllableCount</span> <span class="p">=</span> <span class="m">4</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">(</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">));</span>
        <span class="n">syllableCount</span> <span class="p">=</span> <span class="n">SyllableMapping</span><span class="p">[</span><span class="n">syllableCount</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">syllableCount</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">consonant</span> <span class="p">=</span> <span class="n">Consonants</span><span class="p">[</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">Consonants</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
            <span class="kt">var</span> <span class="n">vowel</span> <span class="p">=</span> <span class="n">Vowels</span><span class="p">[</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">Vowels</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pascal</span> <span class="p">||</span> <span class="n">i</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">j</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">consonant</span> <span class="p">=</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">CurrentCulture</span><span class="p">.</span><span class="n">TextInfo</span><span class="p">.</span><span class="nf">ToTitleCase</span><span class="p">(</span><span class="n">consonant</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">builder</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="n">consonant</span><span class="p">);</span>
            <span class="n">builder</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="n">vowel</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>▲ 这个方法可以在 <a href="/post/algorithm-of-generating-random-identifiers">冷算法：自动生成代码标识符（类名、方法名、变量名）</a> 找到。</p><p>流程混淆修改方法内部的实现。为了了解各种不同的流程混淆级别对代码的影响，我为每一个混淆级别都进行反编译查看。</p><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-17-19-24.png" alt="没有混淆" /><br /> ▲ 没有混淆</p><h3 id="0-级流程混淆">0 级流程混淆<a href="#0-级流程混淆"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-17-26-39.png" alt="0 级流程混淆" /><br /> ▲ 0 级流程混淆</p><h3 id="1-级流程混淆">1 级流程混淆<a href="#1-级流程混淆"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-17-24-43.png" alt="1 级流程混淆" /><br /> ▲ 1 级流程混淆</p><p>可以发现 0 和 1 其实完全一样。又被 SmartAssembly 耍了。</p><h3 id="2-级流程混淆">2 级流程混淆<a href="#2-级流程混淆"><i class="fas fa-hashtag"></i></a></h3></h3><p>2 级流程混淆代码很长，所以我没有贴图：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre><td class="rouge-code"><pre><span class="c1">// Token: 0x06000004 RID: 4 RVA: 0x00002070 File Offset: 0x00000270</span>
<span class="k">public</span> <span class="kt">string</span> <span class="nf">Generate</span><span class="p">(</span><span class="kt">bool</span> <span class="n">pascal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="n">StringBuilder</span> <span class="n">stringBuilder2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(-</span><span class="m">1</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringBuilder2</span> <span class="p">=</span> <span class="n">stringBuilder</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">num2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="n">num2</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">WordCount</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num4</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num3</span> <span class="p">=</span> <span class="n">num4</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num6</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num8</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num3</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">num5</span> <span class="p">=</span> <span class="p">(</span><span class="n">num</span> <span class="p">&lt;=</span> <span class="n">num3</span><span class="p">)</span> <span class="p">?</span> <span class="p">(</span><span class="m">4</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">9</span><span class="p">)))</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">WordCount</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">num6</span> <span class="p">=</span> <span class="n">num5</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">num7</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">num8</span> <span class="p">=</span> <span class="n">num7</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">goto</span> <span class="n">IL_10E</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">7</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">goto</span> <span class="n">IL_134</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">goto</span> <span class="n">IL_8E</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">IL_6C</span><span class="p">:</span>
    <span class="kt">int</span> <span class="n">num9</span> <span class="p">=</span> <span class="n">num2</span> <span class="p">-</span> <span class="n">num4</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num10</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">num10</span> <span class="p">=</span> <span class="n">num9</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">num11</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">SyllableMapping</span><span class="p">[</span><span class="n">num10</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="m">6</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">num10</span> <span class="p">=</span> <span class="n">num11</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">IL_86</span><span class="p">:</span>
    <span class="kt">int</span> <span class="n">num12</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num13</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">num13</span> <span class="p">=</span> <span class="n">num12</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">IL_8E</span><span class="p">:</span>
    <span class="k">goto</span> <span class="n">IL_11E</span><span class="p">;</span>
    <span class="n">IL_10E</span><span class="p">:</span>
    <span class="kt">string</span> <span class="k">value</span><span class="p">;</span>
    <span class="n">stringBuilder2</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="n">num13</span><span class="p">++;</span>
    <span class="n">IL_11E</span><span class="p">:</span>
    <span class="kt">string</span> <span class="n">text</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">flag</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num13</span> <span class="p">&gt;=</span> <span class="n">num10</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">num8</span><span class="p">++;</span>
            <span class="k">goto</span> <span class="n">IL_134</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">text</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Consonants</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Consonants</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
        <span class="k">value</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Vowels</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Vowels</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
        <span class="n">flag</span> <span class="p">=</span> <span class="p">((</span><span class="n">pascal</span> <span class="p">||</span> <span class="n">num8</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">num13</span> <span class="p">==</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">text</span> <span class="p">=</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">CurrentCulture</span><span class="p">.</span><span class="n">TextInfo</span><span class="p">.</span><span class="nf">ToTitleCase</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringBuilder2</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">IL_10E</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">goto</span> <span class="n">IL_86</span><span class="p">;</span>
    <span class="n">IL_134</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num8</span> <span class="p">&gt;=</span> <span class="n">num6</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">stringBuilder2</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">num2</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
    <span class="n">num4</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">));</span>
    <span class="k">goto</span> <span class="n">IL_6C</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>▲ 2 级流程混淆</p><p>这时就发现代码的可读性降低了，需要耐心才能解读其含义。</p><h3 id="3-级流程混淆">3 级流程混淆<a href="#3-级流程混淆"><i class="fas fa-hashtag"></i></a></h3></h3><p>以下是 3 级流程混淆：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre><td class="rouge-code"><pre><span class="c1">// Token: 0x06000004 RID: 4 RVA: 0x0000207C File Offset: 0x0000027C</span>
<span class="k">public</span> <span class="kt">string</span> <span class="nf">Generate</span><span class="p">(</span><span class="kt">bool</span> <span class="n">pascal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">num2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="n">num2</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">WordCount</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num4</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num3</span> <span class="p">=</span> <span class="n">num4</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num7</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num8</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num3</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">num5</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="p">&gt;</span> <span class="n">num3</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">num5</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">WordCount</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">num6</span> <span class="p">=</span> <span class="n">num5</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num6</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">num5</span> <span class="p">=</span> <span class="n">num6</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">9</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">num7</span> <span class="p">=</span> <span class="n">num5</span><span class="p">;</span>
        <span class="n">num8</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">goto</span> <span class="n">IL_104</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">7</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">goto</span> <span class="n">IL_84</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">goto</span> <span class="n">IL_12A</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">IL_73</span><span class="p">:</span>
    <span class="kt">int</span> <span class="n">num9</span> <span class="p">=</span> <span class="n">num2</span> <span class="p">-</span> <span class="n">num4</span><span class="p">;</span>
    <span class="n">num9</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">SyllableMapping</span><span class="p">[</span><span class="n">num9</span><span class="p">];</span>
    <span class="n">IL_81</span><span class="p">:</span>
    <span class="kt">int</span> <span class="n">num10</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="n">IL_84</span><span class="p">:</span>
    <span class="k">goto</span> <span class="n">IL_114</span><span class="p">;</span>
    <span class="n">IL_104</span><span class="p">:</span>
    <span class="kt">string</span> <span class="k">value</span><span class="p">;</span>
    <span class="n">stringBuilder</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="n">num10</span><span class="p">++;</span>
    <span class="n">IL_114</span><span class="p">:</span>
    <span class="kt">string</span> <span class="n">text</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">flag</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num10</span> <span class="p">&gt;=</span> <span class="n">num9</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">num8</span><span class="p">++;</span>
            <span class="k">goto</span> <span class="n">IL_12A</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">text</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Consonants</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Consonants</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
        <span class="k">value</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Vowels</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Vowels</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
        <span class="n">flag</span> <span class="p">=</span> <span class="p">((</span><span class="n">pascal</span> <span class="p">||</span> <span class="n">num8</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">num10</span> <span class="p">==</span> <span class="m">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">text</span> <span class="p">=</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">CurrentCulture</span><span class="p">.</span><span class="n">TextInfo</span><span class="p">.</span><span class="nf">ToTitleCase</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringBuilder</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">IL_104</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">goto</span> <span class="n">IL_81</span><span class="p">;</span>
    <span class="n">IL_12A</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num8</span> <span class="p">&lt;</span> <span class="n">num7</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">num2</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
        <span class="n">num4</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">));</span>
        <span class="k">goto</span> <span class="n">IL_73</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">stringBuilder</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>▲ 3 级流程混淆</p><p>3 级流程混淆并没有比 2 级高多少，可读性差不多。不过需要注意的是，这些差异并不是随机差异，因为重复生成得到的流程结果是相同的。</p><h3 id="4-级流程混淆">4 级流程混淆<a href="#4-级流程混淆"><i class="fas fa-hashtag"></i></a></h3></h3><p>以下是 4 级流程混淆：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c1">// Token: 0x06000004 RID: 4 RVA: 0x0000207C File Offset: 0x0000027C</span>
<span class="k">public</span> <span class="k">unsafe</span> <span class="kt">string</span> <span class="nf">Generate</span><span class="p">(</span><span class="kt">bool</span> <span class="n">pascal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">void</span><span class="p">*</span> <span class="n">ptr</span> <span class="p">=</span> <span class="k">stackalloc</span> <span class="kt">byte</span><span class="p">[</span><span class="m">14</span><span class="p">];</span>
    <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="n">StringBuilder</span> <span class="n">stringBuilder2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(!</span><span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringBuilder2</span> <span class="p">=</span> <span class="n">stringBuilder</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">WordCount</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">?</span> <span class="p">(</span><span class="m">4</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">9</span><span class="p">)))</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">WordCount</span><span class="p">;</span>
    <span class="p">*(</span><span class="kt">int</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="p">((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span><span class="p">)[</span><span class="m">13</span><span class="p">]</span> <span class="p">=</span> <span class="p">((*(</span><span class="kt">int</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">&lt;</span> <span class="n">num</span><span class="p">)</span> <span class="p">?</span> <span class="m">1</span> <span class="p">:</span> <span class="m">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(*(</span><span class="kt">sbyte</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">13</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">4</span><span class="p">)</span> <span class="p">=</span> <span class="m">4</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Sqrt</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">));</span>
        <span class="p">*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">4</span><span class="p">)</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">SyllableMapping</span><span class="p">[*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">4</span><span class="p">)];</span>
        <span class="p">*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">8</span><span class="p">)</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="p">((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span><span class="p">)[</span><span class="m">12</span><span class="p">]</span> <span class="p">=</span> <span class="p">((*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">8</span><span class="p">)</span> <span class="p">&lt;</span> <span class="p">*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">4</span><span class="p">))</span> <span class="p">?</span> <span class="m">1</span> <span class="p">:</span> <span class="m">0</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(*(</span><span class="kt">sbyte</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">12</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Consonants</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Consonants</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
            <span class="kt">string</span> <span class="k">value</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Vowels</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Vowels</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
            <span class="kt">bool</span> <span class="n">flag</span> <span class="p">=</span> <span class="p">(</span><span class="n">pascal</span> <span class="p">||</span> <span class="p">*(</span><span class="kt">int</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">8</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">text</span> <span class="p">=</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">CurrentCulture</span><span class="p">.</span><span class="n">TextInfo</span><span class="p">.</span><span class="nf">ToTitleCase</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">stringBuilder2</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
            <span class="n">stringBuilder2</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
            <span class="p">*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">8</span><span class="p">)</span> <span class="p">=</span> <span class="p">*(</span><span class="kt">int</span><span class="p">*)((</span><span class="kt">byte</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">8</span><span class="p">)</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">*(</span><span class="kt">int</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">=</span> <span class="p">*(</span><span class="kt">int</span><span class="p">*)</span><span class="n">ptr</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">stringBuilder2</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>▲ 4 级流程混淆</p><p>我们发现，4 级已经开始使用没有含义的指针来转换我们的内部实现了。这时除了外部调用以外，代码基本已无法解读其含义了。</p><h2 id="动态代理-references-dynamic-proxy">动态代理 References Dynamic Proxy<a href="#动态代理-references-dynamic-proxy"><i class="fas fa-hashtag"></i></a></h2></h2><p>还是以上一节中我们 Generate 方法作为示例，在开启了动态代理之后（仅开启动态代理，其他都关掉），方法变成了下面这样：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">// Token: 0x06000004 RID: 4 RVA: 0x0000206C File Offset: 0x0000026C</span>
<span class="k">public</span> <span class="kt">string</span> <span class="nf">Generate</span><span class="p">(</span><span class="kt">bool</span> <span class="n">pascal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">WordCount</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">?</span> <span class="p">(</span><span class="m">4</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="err">\</span><span class="n">u0002</span><span class="p">.</span><span class="err">\</span><span class="nf">u0002</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="err">\</span><span class="n">u0001</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0001</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">9</span><span class="p">)))</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">WordCount</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">num2</span> <span class="p">=</span> <span class="m">4</span> <span class="p">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="err">\</span><span class="n">u0002</span><span class="p">.</span><span class="err">\</span><span class="nf">u0002</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="err">\</span><span class="n">u0001</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0001</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">16</span><span class="p">));</span>
        <span class="n">num2</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">SyllableMapping</span><span class="p">[</span><span class="n">num2</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">num2</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Consonants</span><span class="p">[</span><span class="err">\</span><span class="n">u0003</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0003</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">,</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Consonants</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
            <span class="kt">string</span> <span class="n">text2</span> <span class="p">=</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Vowels</span><span class="p">[</span><span class="err">\</span><span class="n">u0003</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0003</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">_random</span><span class="p">,</span> <span class="n">RandomIdentifier</span><span class="p">.</span><span class="n">Vowels</span><span class="p">.</span><span class="n">Count</span><span class="p">)];</span>
            <span class="kt">bool</span> <span class="n">flag</span> <span class="p">=</span> <span class="p">(</span><span class="n">pascal</span> <span class="p">||</span> <span class="n">i</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">j</span> <span class="p">==</span> <span class="m">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">text</span> <span class="p">=</span> <span class="err">\</span><span class="n">u0006</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0006</span><span class="p">(</span><span class="err">\</span><span class="n">u0005</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0005</span><span class="p">(</span><span class="err">\</span><span class="n">u0004</span><span class="p">.</span><span class="err">\</span><span class="nf">u0004</span><span class="p">()),</span> <span class="n">text</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="err">\</span><span class="n">u0007</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0007</span><span class="p">(</span><span class="n">stringBuilder</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
            <span class="err">\</span><span class="n">u0007</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0007</span><span class="p">(</span><span class="n">stringBuilder</span><span class="p">,</span> <span class="n">text2</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="err">\</span><span class="n">u0008</span><span class="p">.~</span><span class="err">\</span><span class="nf">u0008</span><span class="p">(</span><span class="n">stringBuilder</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>▲ 动态代理</p><p>注意到 <code class="language-plaintext highlighter-rouge">_random.Next(0, 9)</code> 变成了 <code class="language-plaintext highlighter-rouge">\u0001.~\u0001(this._random, 0, 9)</code>，<code class="language-plaintext highlighter-rouge">Math.Sqrt(num)</code> 变成了 <code class="language-plaintext highlighter-rouge">\u0002.\u0002(num)</code>。</p><p>也就是说，一些常规方法的调用被替换成了一个代理类的调用。那么代理类在哪里呢？</p><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-18-07-53.png" alt="生成的代理类" /><br /> ▲ 生成的代理类</p><p>生成的代理类都在根命名空间下。比如刚刚的 <code class="language-plaintext highlighter-rouge">\u0001.~\u0001</code> 调用，就是下面这个代理类：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// Token: 0x0200001A RID: 26</span>
<span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="err">\</span><span class="nc">u0001</span> <span class="p">:</span> <span class="n">MulticastDelegate</span>
<span class="p">{</span>
    <span class="c1">// Token: 0x06000030 RID: 48</span>
    <span class="k">public</span> <span class="k">extern</span> <span class="err">\</span><span class="nf">u0001</span><span class="p">(</span><span class="kt">object</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">);</span>

    <span class="c1">// Token: 0x06000031 RID: 49</span>
    <span class="k">public</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">Invoke</span><span class="p">(</span><span class="kt">object</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

    <span class="c1">// Token: 0x06000032 RID: 50 RVA: 0x000030A8 File Offset: 0x000012A8</span>
    <span class="k">static</span> <span class="err">\</span><span class="nf">u0001</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">MemberRefsProxy</span><span class="p">.</span><span class="nf">CreateMemberRefsDelegates</span><span class="p">(</span><span class="m">25</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Token: 0x04000016 RID: 22</span>
    <span class="k">internal</span> <span class="k">static</span> <span class="err">\</span><span class="n">u0001</span> <span class="err">\</span><span class="n">u0001</span><span class="p">;</span>

    <span class="c1">// Token: 0x04000017 RID: 23</span>
    <span class="k">internal</span> <span class="k">static</span> <span class="err">\</span><span class="n">u0001</span> <span class="p">~</span><span class="err">\</span><span class="n">u0001</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="字符串编码与加密-strings-encoding">字符串编码与加密 Strings Encoding<a href="#字符串编码与加密-strings-encoding"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="字符串统一收集编码-encode">字符串统一收集编码 Encode<a href="#字符串统一收集编码-encode"><i class="fas fa-hashtag"></i></a></h3></h3><p>字符串编码将程序集中的字符串都统一收集起来，存为一个资源；然后提供一个辅助类统一获取这些字符串。</p><p>比如 Whitman.Core 中的字符串现在被统一收集了：</p><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-18-16-06.png" alt="统一收集的字符串和解密辅助类" /><br /> ▲ 统一收集的字符串和解密辅助类</p><p>在我的项目中，统一收集的字符串可以形成下面这份字符串（也即是上图中 Resources 文件夹中的那个文件内容）：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre> cQ== dw== cg== dA== eQ== cA== cw== ZA== Zg== Zw== aA== ag== aw== bA== eg== eA==
 Yw== dg== Yg== bg== bQ== dHI= ZHI= Y2g= d2g= c3Q= YQ== ZQ== aQ== bw== dQ== YXI=
 YXM= YWk= YWly YXk= YWw= YWxs YXc= ZWU= ZWE= ZWFy ZW0= ZXI= ZWw= ZXJl aXM= aXI=
 b3U= b3I= b28= b3c= dXI= MjAxOC0wOC0yNlQxODoxMDo0Mw==`VGhpcyBhc3NlbWJseSBoYXMgY
mVlbiBidWlsdCB3aXRoIFNtYXJ0QXNzZW1ibHkgezB9LCB3aGljaCBoYXMgZXhwaXJlZC4= RXZhbHVh
dGlvbiBWZXJzaW9uxVGhpcyBhc3NlbWJseSBoYXMgYmVlbiBidWlsdCB3aXRoIFNtYXJ0QXNzZW1ibHk
gezB9LCBhbmQgdGhlcmVmb3JlIGNhbm5vdCBiZSBkaXN0cmlidXRlZC4= IA== Ni4xMi41Ljc5OQ== 
U21hcnRBc3NlbWJseQ== UGF0aA== U29mdHdhcmVcUmVkIEdhdGVc(U29mdHdhcmVcV293NjQzMk5vZ
GVcUmVkIEdhdGVc
</pre></table></code></div></div><p>由于这些不可见字符让我的博客挂掉了，所以我用图来补，上文就换成空格了……</p><p><img data-proofer-ignore data-src="/static/posts/2021-12-20-23-13-22.png" alt="带有不可见字符的图片" /></p><p>虽然字符串难以读懂，但其实我原本就是这么写的；给你看看我的原始代码就知道了（来自 <a href="/post/algorithm-of-generating-random-identifiers">冷算法：自动生成代码标识符（类名、方法名、变量名）</a>）：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">Consonants</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="s">"q"</span><span class="p">,</span><span class="s">"w"</span><span class="p">,</span><span class="s">"r"</span><span class="p">,</span><span class="s">"t"</span><span class="p">,</span><span class="s">"y"</span><span class="p">,</span><span class="s">"p"</span><span class="p">,</span><span class="s">"s"</span><span class="p">,</span><span class="s">"d"</span><span class="p">,</span><span class="s">"f"</span><span class="p">,</span><span class="s">"g"</span><span class="p">,</span><span class="s">"h"</span><span class="p">,</span><span class="s">"j"</span><span class="p">,</span><span class="s">"k"</span><span class="p">,</span><span class="s">"l"</span><span class="p">,</span><span class="s">"z"</span><span class="p">,</span><span class="s">"x"</span><span class="p">,</span><span class="s">"c"</span><span class="p">,</span><span class="s">"v"</span><span class="p">,</span><span class="s">"b"</span><span class="p">,</span><span class="s">"n"</span><span class="p">,</span><span class="s">"m"</span><span class="p">,</span>
    <span class="s">"w"</span><span class="p">,</span><span class="s">"r"</span><span class="p">,</span><span class="s">"t"</span><span class="p">,</span><span class="s">"p"</span><span class="p">,</span><span class="s">"s"</span><span class="p">,</span><span class="s">"d"</span><span class="p">,</span><span class="s">"f"</span><span class="p">,</span><span class="s">"g"</span><span class="p">,</span><span class="s">"h"</span><span class="p">,</span><span class="s">"j"</span><span class="p">,</span><span class="s">"k"</span><span class="p">,</span><span class="s">"l"</span><span class="p">,</span><span class="s">"c"</span><span class="p">,</span><span class="s">"b"</span><span class="p">,</span><span class="s">"n"</span><span class="p">,</span><span class="s">"m"</span><span class="p">,</span>
    <span class="s">"r"</span><span class="p">,</span><span class="s">"t"</span><span class="p">,</span><span class="s">"p"</span><span class="p">,</span><span class="s">"s"</span><span class="p">,</span><span class="s">"d"</span><span class="p">,</span><span class="s">"h"</span><span class="p">,</span><span class="s">"j"</span><span class="p">,</span><span class="s">"k"</span><span class="p">,</span><span class="s">"l"</span><span class="p">,</span><span class="s">"c"</span><span class="p">,</span><span class="s">"b"</span><span class="p">,</span><span class="s">"n"</span><span class="p">,</span><span class="s">"m"</span><span class="p">,</span>
    <span class="s">"r"</span><span class="p">,</span><span class="s">"t"</span><span class="p">,</span><span class="s">"s"</span><span class="p">,</span><span class="s">"j"</span><span class="p">,</span><span class="s">"c"</span><span class="p">,</span><span class="s">"n"</span><span class="p">,</span><span class="s">"m"</span><span class="p">,</span>
    <span class="s">"tr"</span><span class="p">,</span><span class="s">"dr"</span><span class="p">,</span><span class="s">"ch"</span><span class="p">,</span><span class="s">"wh"</span><span class="p">,</span><span class="s">"st"</span><span class="p">,</span>
    <span class="s">"s"</span><span class="p">,</span><span class="s">"s"</span>
<span class="p">};</span>
</pre></table></code></div></div><p>生成的字符串获取辅助类就像下面这样不太容易读懂：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre><td class="rouge-code"><pre><span class="c1">// Token: 0x0200000A RID: 10</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Strings</span>
<span class="p">{</span>
    <span class="c1">// Token: 0x0600001C RID: 28 RVA: 0x00002B94 File Offset: 0x00000D94</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">stringID</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">stringID</span> <span class="p">-=</span> <span class="n">Strings</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Strings</span><span class="p">.</span><span class="n">cacheStrings</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">object</span> <span class="n">obj</span> <span class="p">=</span> <span class="n">Strings</span><span class="p">.</span><span class="n">hashtableLock</span><span class="p">;</span>
            <span class="k">lock</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">string</span> <span class="n">text</span><span class="p">;</span>
                <span class="n">Strings</span><span class="p">.</span><span class="n">hashtable</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">stringID</span><span class="p">,</span> <span class="k">out</span> <span class="n">text</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">text</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">text</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="n">stringID</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Strings</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">index</span><span class="p">++];</span>
        <span class="kt">int</span> <span class="n">num2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">num</span> <span class="p">&amp;</span> <span class="m">128</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">num2</span> <span class="p">=</span> <span class="n">num</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num2</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">num</span> <span class="p">&amp;</span> <span class="m">64</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">num2</span> <span class="p">=</span> <span class="p">((</span><span class="n">num</span> <span class="p">&amp;</span> <span class="m">63</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="m">8</span><span class="p">)</span> <span class="p">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Strings</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">index</span><span class="p">++];</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">num2</span> <span class="p">=</span> <span class="p">((</span><span class="n">num</span> <span class="p">&amp;</span> <span class="m">31</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="m">24</span><span class="p">)</span> <span class="p">+</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">Strings</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">index</span><span class="p">++]</span> <span class="p">&lt;&lt;</span> <span class="m">16</span><span class="p">)</span> <span class="p">+</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">Strings</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">index</span><span class="p">++]</span> <span class="p">&lt;&lt;</span> <span class="m">8</span><span class="p">)</span> <span class="p">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Strings</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">index</span><span class="p">++];</span>
        <span class="p">}</span>
        <span class="kt">string</span> <span class="n">result</span><span class="p">;</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">FromBase64String</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">Strings</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">num2</span><span class="p">));</span>
            <span class="kt">string</span> <span class="n">text2</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Intern</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">array</span><span class="p">.</span><span class="n">Length</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Strings</span><span class="p">.</span><span class="n">cacheStrings</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="kt">object</span> <span class="n">obj</span> <span class="p">=</span> <span class="n">Strings</span><span class="p">.</span><span class="n">hashtableLock</span><span class="p">;</span>
                    <span class="k">lock</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">Strings</span><span class="p">.</span><span class="n">hashtable</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">stringID</span><span class="p">,</span> <span class="n">text2</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">catch</span>
                <span class="p">{</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">result</span> <span class="p">=</span> <span class="n">text2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span>
        <span class="p">{</span>
            <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Token: 0x0600001D RID: 29 RVA: 0x00002CF4 File Offset: 0x00000EF4</span>
    <span class="k">static</span> <span class="nf">Strings</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Strings</span><span class="p">.</span><span class="n">MustUseCache</span> <span class="p">==</span> <span class="s">"1"</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Strings</span><span class="p">.</span><span class="n">cacheStrings</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">Strings</span><span class="p">.</span><span class="n">hashtable</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
        <span class="p">}</span>
        <span class="n">Strings</span><span class="p">.</span><span class="n">offset</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">Strings</span><span class="p">.</span><span class="n">OffsetValue</span><span class="p">);</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">Stream</span> <span class="n">manifestResourceStream</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">().</span><span class="nf">GetManifestResourceStream</span><span class="p">(</span><span class="s">"{f6b5a51a-b2fb-4143-af01-e2295062799f}"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">manifestResourceStream</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="n">Strings</span><span class="p">.</span><span class="n">bytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
            <span class="n">manifestResourceStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">Strings</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
            <span class="n">manifestResourceStream</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Token: 0x0400000C RID: 12</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">MustUseCache</span> <span class="p">=</span> <span class="s">"0"</span><span class="p">;</span>

    <span class="c1">// Token: 0x0400000D RID: 13</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">OffsetValue</span> <span class="p">=</span> <span class="s">"203"</span><span class="p">;</span>

    <span class="c1">// Token: 0x0400000E RID: 14</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="c1">// Token: 0x0400000F RID: 15</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">hashtable</span><span class="p">;</span>

    <span class="c1">// Token: 0x04000010 RID: 16</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">hashtableLock</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>

    <span class="c1">// Token: 0x04000011 RID: 17</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">bool</span> <span class="n">cacheStrings</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="c1">// Token: 0x04000012 RID: 18</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">offset</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>生成字符串获取辅助类后，原本写着字符串的地方就会被替换为 <code class="language-plaintext highlighter-rouge">Strings.Get(int)</code> 方法的调用。</p><h3 id="字符串压缩加密-compress">字符串压缩加密 Compress<a href="#字符串压缩加密-compress"><i class="fas fa-hashtag"></i></a></h3></h3><p>前面那份统一收集的字符串依然还是明文存储为资源，但还可以进行压缩。这时，Resources 中的那份字符串资源现在是二进制文件（截取前 256 字节）：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>00000000:  7b7a  7d02  efbf  bdef  bfbd  4def  bfbd  efbf
00000010:  bd7e  6416  efbf  bd6a  efbf  bd22  efbf  bd08
00000020:  efbf  bdef  bfbd  4c42  7138  72ef  bfbd  efbf
00000030:  bd54  1337  efbf  bd0e  22ef  bfbd  69ef  bfbd
00000040:  613d  efbf  bd6e  efbf  bd35  efbf  bd0a  efbf
00000050:  bd33  6043  efbf  bd26  59ef  bfbd  5471  efbf
00000060:  bdef  bfbd  2cef  bfbd  18ef  bfbd  6def  bfbd
00000070:  efbf  bdef  bfbd  64ef  bfbd  c9af  efbf  bdef
00000080:  bfbd  efbf  bd4b  efbf  bdef  bfbd  66ef  bfbd
00000090:  1e70  efbf  bdef  bfbd  ce91  71ef  bfbd  1d5e
000000a0:  1863  efbf  bd16  0473  25ef  bfbd  2204  efbf
000000b0:  bdef  bfbd  11ef  bfbd  4fef  bfbd  265a  375f
000000c0:  7bef  bfbd  19ef  bfbd  d5bd  efbf  bdef  bfbd
000000d0:  efbf  bd70  71ef  bfbd  efbf  bd05  c789  efbf
000000e0:  bd51  eaae  beef  bfbd  ee97  adef  bfbd  0a33
000000f0:  d986  141c  2bef  bfbd  efbf  bdef  bfbd  1fef
</pre></table></code></div></div><p>这份压缩的字符串在程序启动的时候会进行一次解压，随后就直接读取解压后的字符串了。所以会占用启动时间（虽然不长），但不会占用太多运行时时间。</p><p>为了能够解压出这些压缩的字符串，<code class="language-plaintext highlighter-rouge">Strings</code> 类相比于之前会在读取后进行一次解压缩（解密）。可以看下面我额外标注出的 <code class="language-plaintext highlighter-rouge">Strings</code> 类新增的一行。</p><div class="language-diff highlighter-rouge"><div class="code-header"> <span label-text="Diff"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>   using (Stream manifestResourceStream = Assembly.GetExecutingAssembly().GetManifestResourceStream("{4f639d09-ce0f-4092-b0c7-b56c205d48fd}"))
   {
       int num = Convert.ToInt32(manifestResourceStream.Length);
       byte[] buffer = new byte[num];
       manifestResourceStream.Read(buffer, 0, num);
<span class="gi">++     Strings.bytes = SimpleZip.Unzip(buffer);
</span>       manifestResourceStream.Close();
   }
</pre></table></code></div></div><p>至于嵌入其中的解压与解密类 <code class="language-plaintext highlighter-rouge">SimpleZip</code>，我就不能贴出来了，因为反编译出来有 3000+ 行：</p><p><img data-proofer-ignore data-src="/static/posts/2018-08-19-18-34-18.png" alt="3000+ 行的解压与解密类" /></p><h3 id="字符串缓存-usecache">字符串缓存 UseCache<a href="#字符串缓存-usecache"><i class="fas fa-hashtag"></i></a></h3></h3><p>与其他的缓存策略一样，每次获取字符串都太消耗计算资源的话，就可以拿内存空间进行缓存。</p><p>在实际混淆中，我发现无论我是否开启了字符串缓存，实际 <code class="language-plaintext highlighter-rouge">Strings.Get</code> 方法都会缓存字符串。你可以回到上面去重新阅读 <code class="language-plaintext highlighter-rouge">Strings.Get</code> 方法的代码，发现其本来就已带缓存。这可能是 SmartAssembly 的 Bug。</p><h3 id="使用类的内部委托获取字符串-useimprovedencoding">使用类的内部委托获取字符串 UseImprovedEncoding<a href="#使用类的内部委托获取字符串-useimprovedencoding"><i class="fas fa-hashtag"></i></a></h3></h3><p>之前的混淆都会在原来有字符串地方使用 <code class="language-plaintext highlighter-rouge">Strings.Get</code> 来获取字符串。而如果开启了这一选项，那么 <code class="language-plaintext highlighter-rouge">Strings.Get</code> 就不是全局调用的了，而是在类的内部调用一个委托字段。</p><p>比如从 <code class="language-plaintext highlighter-rouge">Strings.Get</code> 调用修改为 <code class="language-plaintext highlighter-rouge">\u0010(),</code>，而 <code class="language-plaintext highlighter-rouge">\u0010</code> 是我们自己的类 <code class="language-plaintext highlighter-rouge">RandomIdentifier</code> 内部的被额外加进去的一个字段 <code class="language-plaintext highlighter-rouge">internal static GetString \u0010;</code>。</p><h2 id="防止-msil-disassembler-对其进行反编译-msil-disassembler-protection">防止 MSIL Disassembler 对其进行反编译 MSIL Disassembler Protection<a href="#防止-msil-disassembler-对其进行反编译-msil-disassembler-protection"><i class="fas fa-hashtag"></i></a></h2></h2><p>这其实是个没啥用的选项，因为我们程序集只会多出一个全局的特性：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">assembly</span><span class="p">:</span> <span class="n">SuppressIldasm</span><span class="p">]</span>
</pre></table></code></div></div><p>只有 MSIL Disassembler 和基于 MSIL Disassembler 的工具认这个特性。真正想逆向程序集的，根本不会在乎 MSIL Disassembler 被禁掉。</p><p>dnSpy 和 dotPeek 实际上都忽略了这个特性，依然能毫无障碍地反编译。</p><p>dnSpy 可以做挺多事儿的，比如：</p><ul><li><a href="https://blog.lindexi.com/post/%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95-Windows-%E6%BA%90%E4%BB%A3%E7%A0%81.html">断点调试 Windows 源代码 - lindexi</a><li><a href="/post/edit-and-recompile-assembly-using-dnspy">神器如 dnSpy，无需源码也能修改 .NET 程序 - walterlv</a></ul><h2 id="密封">密封<a href="#密封"><i class="fas fa-hashtag"></i></a></h2></h2><p>在 <code class="language-plaintext highlighter-rouge">OtherOptimizations</code> 选项中，有一项 <code class="language-plaintext highlighter-rouge">SealClasses</code> 可以将所有可以密封的类进行密封（当然，此操作不会修改 API）。</p><p>在上面的例子中，由于 <code class="language-plaintext highlighter-rouge">RandomIdentifier</code> 是公有类，可能被继承，所以只有预先写的内部的 <code class="language-plaintext highlighter-rouge">UnusedClass</code> 被其标记为密封了。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c1">// Token: 0x02000003 RID: 3</span>
<span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">UnusedClass</span>
<span class="p">{</span>
    <span class="c1">// Token: 0x06000007 RID: 7 RVA: 0x000026D0 File Offset: 0x000008D0</span>
    <span class="k">internal</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// Token: 0x06000008 RID: 8 RVA: 0x000026D4 File Offset: 0x000008D4</span>
    <span class="k">internal</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">RunAsync</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="实际项目中我该如何选择">实际项目中，我该如何选择<a href="#实际项目中我该如何选择"><i class="fas fa-hashtag"></i></a></h2></h2><p>既然你希望选择“混淆”，那么你肯定是希望能进行最大程度的保护。在保证你没有额外产生 Bug，性能没有明显损失的情况下，能混淆得多厉害就混淆得多厉害。</p><p>基于这一原则，我推荐的混淆方案有（按推荐顺序排序）：</p><ol><li>流程混淆<ul><li>建议必选<li>直接选用 4 级流程（不安全代码）混淆，如果出问题才换为 3 级（goto）混淆，理论上不需要使用更低级别<li>流程混淆对性能的影响是非常小的，因为多执行的代码都是有编译期级别优化的，没有太多性能开销的代码<li>流程混淆仅影响实现，不修改 API，所以基本不会影响其他程序各种对此程序集的调用</ul><li>名称混淆<ul><li>尽量选择<li>任意选择类/方法名和字段名的级别，只要能编译通过就行（因为无论选哪个，对程序的影响都一样，逆向的难度差异也较小）<li>名称混淆不影响程序执行性能，所以只要能打开，就尽量打开<li>如果有 <code class="language-plaintext highlighter-rouge">InternalsVisibleTo</code> 或者可能被其他程序集按名称反射调用，请：<ul><li><strong>关闭此混淆</strong><li>使用 Exclude 排除特定命名空间，使此命名空间下的类/方法名不进行名称混淆<li>如果你能接受用 Attribute 标记某些类不应该混淆类名，也可以使用这些标记（只是我不推荐这么做，这让混淆污染了自己的代码）</ul></ul><li>动态代理<ul><li>推荐选择<li>动态代理仅影响实现，不修改 API，所以基本不会影响其他程序各种对此程序集的调用<li>动态代理会生成新的类/委托来替换之前的方法调用，所以可能造成非常轻微的性能损失（一般可以忽略）</ul><li>字符串压缩加密<ul><li>可以选择<li>由于所有的字符串都被统一成一个资源，如果额外进行压缩加密，那么逆向时理解程序的含义将变得非常困难（没有可以参考的锚点）<li>会对启动时间有轻微的性能影响，如果额外压缩加密，那么会有更多性能影响；如果你对启动性能要求较高，还是不要选了<li>会轻微增加内存占用和读取字符串时的 CPU 占用，如果你对程序性能要求非常高，还是不要选了</ul></ol><p>以上四种混淆方式从四个不同的维度对你类与方法的实现进行了混淆，使得你写的类的任何地方都变得无法辨认。流程混淆修改方法内实现的逻辑，名称混淆修改类/属性/方法的名称，动态代理将方法内对其他方法的调用变得不再直接，字符串压缩加密将使得字符串不再具有可读的含义。对逆向阅读影响最大的就是以上 4 种混淆了，如果可能，建议都选择开启。</p><p>如果你的程序中有需要保护的“嵌入的资源”，在没有自己的保护手段的情况下，可以使用“资源压缩加密”。不过，我更加推荐你自己进行加密。</p><p>至于 SmartAssembly 推荐的其他选项，都是噱头重于实际效果：</p><ul><li>裁剪<ul><li>一般也不会有多少开发者会故意往程序集中写一些不会用到的类吧！</ul><li>依赖合并/依赖嵌入<ul><li>并不会对逆向造成障碍，开不开启差别不大，反而降低了性能</ul><li>防止 MSIL Disassembler 反编译<ul><li>并不会对逆向造成障碍，防君子不防小人</ul><li>密封类<ul><li>声称可以提升性能，但这点性能提升微乎其微</ul></ul><p>SmartAssembly 的官方文档写得还是太简单了，很难得到每一个设置项的含义和实际效果。</p><p>以上这些信息的得出，离不开 <a href="https://github.com/0xd4d/dnSpy">dnSpy</a> 的反编译。</p><hr /><p><strong>参考资料</strong></p><ul><li><a href="https://documentation.red-gate.com/sa6">SmartAssembly 6 documentation - SmartAssembly 6 - Product Documentation</a><li><a href="https://documentation.red-gate.com/sa6/obfuscating-your-code-with-smartassembly/obfuscating-code-with-name-mangling">Obfuscating code with name mangling - SmartAssembly 6 - Product Documentation</a></ul><p> 本文会经常更新，请阅读原文： <a href="/post/obfuscation-configurations-of-smart-assembly.html">https://blog.walterlv.com/post/obfuscation-configurations-of-smart-assembly.html</a> ，以避免陈旧错误知识的误导，同时有更好的阅读体验。</p><p> <a rel="知识共享许可协议" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="知识共享许可协议" src="https://blog.walterlv.com/assets/img/by-nc-sa.svg" /> </a></p><p> 本作品采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可。欢迎转载、使用、重新发布，但务必保留文章署名 吕毅 （包含链接： <a href="https://blog.walterlv.com">https://blog.walterlv.com</a> ），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。如有任何疑问，请 <a href="mailto:walter.lv@qq.com">与我联系 (walter.lv@qq.com)</a> 。</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="comments-wrapper"> 登录 GitHub 账号进行评论</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=.NET 中各种混淆（Obfuscation）的含义、原理、实际效果和不同级别的差异（使用 SmartAssembly） - walterlv&url=https://blog.walterlv.com/post/obfuscation-configurations-of-smart-assembly.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=.NET 中各种混淆（Obfuscation）的含义、原理、实际效果和不同级别的差异（使用 SmartAssembly） - walterlv&u=https://blog.walterlv.com/post/obfuscation-configurations-of-smart-assembly.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=.NET 中各种混淆（Obfuscation）的含义、原理、实际效果和不同级别的差异（使用 SmartAssembly） - walterlv&url=https://blog.walterlv.com/post/obfuscation-configurations-of-smart-assembly.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/post/monitor-foreground-window-on-windows">如何在控制台程序中监听 Windows 前台窗口的变化</a><li><a href="/post/how-to-start-a-process-with-environment-variables-without-code">在 Windows 上如何在启动程序时单独为这个程序指定环境变量，而不需要编写任何代码或脚本</a><li><a href="/post/wpf-draw-a-hsl-hsb-palette-using-hlsl">WPF 像素着色器进阶：使用 HLSL 编写一个高性能的实时变化的 HSL/HSV/HSB 调色盘</a><li><a href="/post/create-wpf-pixel-shader-effects-using-shazzam-shader-editor.html">WPF 像素着色器入门：使用 Shazzam Shader Editor 编写 HLSL 像素着色器代码</a><li><a href="/post/where-is-the-windows-10-native-icons.html">Windows 10 自带那么多图标，去哪里找呢？</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><section class="comments"> <script src="https://utteranc.es/client.js" repo="walterlv/BlogComments" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></section></div></div></div><footer class="d-flex flex-column w-100 justify-content-center"><div id="analytics-box"> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-108101550-1"></script> <script> document.addEventListener("DOMContentLoaded", function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-108101550-1'); }); </script> <script async type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1264408226'%3E%3C/span%3E%3Cscript src='//s22.cnzz.com/z_stat.php%3Fid%3D1264408226%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2014-2024 <a href="https://github.com/walterlv">walterlv</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由吕毅按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，基于 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题修改。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
