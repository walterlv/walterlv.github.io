<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="制作一个极简的 .NET 客户端应用自安装或自更新程序" /><meta name="author" content="吕毅" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="本文主要说的是 .NET 客户端应用，可以是只能在 Windows 端运行的基于 .NET Framework 或基于 .NET Core 的 WPF / Windows Forms 应用，也可以是其他基于 .NET Core 的跨平台应用。但是不是那些更新权限受到严格控制的 UWP / iOS / Android 应用。 本文将编写一个简单的程序，这个程序初次运行的时候会安装自己，如果已安装旧版本会更新自己，如果已安装最新则直接运行。" /><meta property="og:description" content="本文主要说的是 .NET 客户端应用，可以是只能在 Windows 端运行的基于 .NET Framework 或基于 .NET Core 的 WPF / Windows Forms 应用，也可以是其他基于 .NET Core 的跨平台应用。但是不是那些更新权限受到严格控制的 UWP / iOS / Android 应用。 本文将编写一个简单的程序，这个程序初次运行的时候会安装自己，如果已安装旧版本会更新自己，如果已安装最新则直接运行。" /><link rel="canonical" href="https://blog.walterlv.com/post/simple-windows-app-self-installer.html" /><meta property="og:url" content="https://blog.walterlv.com/post/simple-windows-app-self-installer.html" /><meta property="og:site_name" content="walterlv" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-03-22T00:44:03+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="制作一个极简的 .NET 客户端应用自安装或自更新程序" /><meta name="twitter:site" content="@_lvyi_" /><meta name="twitter:creator" content="@吕毅" /> <script type="application/ld+json"> {"datePublished":"2019-03-22T00:44:03+08:00","description":"本文主要说的是 .NET 客户端应用，可以是只能在 Windows 端运行的基于 .NET Framework 或基于 .NET Core 的 WPF / Windows Forms 应用，也可以是其他基于 .NET Core 的跨平台应用。但是不是那些更新权限受到严格控制的 UWP / iOS / Android 应用。 本文将编写一个简单的程序，这个程序初次运行的时候会安装自己，如果已安装旧版本会更新自己，如果已安装最新则直接运行。","dateModified":"2021-12-20T00:40:29+08:00","headline":"制作一个极简的 .NET 客户端应用自安装或自更新程序","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.walterlv.com/post/simple-windows-app-self-installer.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.walterlv.com/assets/img/logo.png"},"name":"吕毅"},"url":"https://blog.walterlv.com/post/simple-windows-app-self-installer.html","author":{"@type":"Person","name":"吕毅"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>制作一个极简的 .NET 客户端应用自安装或自更新程序 - walterlv</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="walterlv"><meta name="application-name" content="walterlv"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="topbar-wrapper" class="row topbar-down"><div id="topbar" class="col-12 d-flex h-100 align-items-center"><div id="topbar-logoside" class="col"> <a id="topbar-logo" href="https://blog.walterlv.com" alt="avatar"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <a id="topbar-title" class="site-title" href="https://blog.walterlv.com" alt="walterlv"> walterlv </a></div><div id="topbar-searchside" class="justify-content-center col-5"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div><div class="col"></div></div></div><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="sidebar-box post-item-box profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">吕毅</a></div><div class="site-subtitle font-italic">.NET and Windows App Developer, Microsoft MVP</div></div><ul class="sidebar-box post-item-box"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/friends/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>朋友和收藏</span> </a><li class="nav-item"> <a href="/mind/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>胡思乱想</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/walterlv" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_lvyi_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['walter.lv','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>制作一个极简的 .NET 客户端应用自安装或自更新程序</h1><div class="post-meta text-muted"><div class="d-flex"> <span> 吕毅 </span> <span> 发表于 <em class="timeago" date="2019-02-27 10:36:29 +0800" data-toggle="tooltip" data-placement="bottom" title="2019-02-27, 10:36 +0800" >2019-02-27</em> </span> <span> 更新于 <em class="timeago" date="2019-03-22 00:44:03 +0800" data-toggle="tooltip" data-placement="bottom" title="2019-03-22, 00:44 +0800" >2019-03-22</em> </span></div></div><div class="post-content"><p>本文主要说的是 .NET 客户端应用，可以是只能在 Windows 端运行的基于 .NET Framework 或基于 .NET Core 的 WPF / Windows Forms 应用，也可以是其他基于 .NET Core 的跨平台应用。但是不是那些更新权限受到严格控制的 UWP / iOS / Android 应用。</p><p>本文将编写一个简单的程序，这个程序初次运行的时候会安装自己，如果已安装旧版本会更新自己，如果已安装最新则直接运行。</p><hr /><div id="toc"></div><h2 id="自安装或自更新的思路">自安装或自更新的思路<a href="#自安装或自更新的思路"><i class="fas fa-hashtag"></i></a></h2></h2><p>简单的安装过程实际上是 <code class="language-plaintext highlighter-rouge">解压 + 复制 + 配置 + 外部命令</code>。这里，我只做 <code class="language-plaintext highlighter-rouge">复制 + 配置 + 外部命令</code>，并且把 <code class="language-plaintext highlighter-rouge">配置 + 外部命令</code> 合为一个步骤。</p><p>于是：</p><ol><li>启动后，检查安装路径下是否有已经安装的程序；<li>如果没有，则直接复制自己过去；<li>如果有，则比较版本号，更新则复制过去。</ol><h2 id="本文用到的知识">本文用到的知识<a href="#本文用到的知识"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><a href="/post/start-process-with-lowered-uac-privileges">在 Windows 系统上降低 UAC 权限运行程序（从管理员权限降权到普通用户权限） - walterlv</a><li><a href="/post/rename-executable-self-when-running">Windows 上的应用程序在运行期间可以给自己改名（可以做 OTA 自我更新） - walterlv</a><li><a href="/post/get-attributes-for-reflection-only-loaded-assembly">仅反射加载（ReflectionOnlyLoadFrom）的 .NET 程序集，如何反射获取它的 Attribute 元数据呢？ - walterlv</a></ul><h2 id="使用">使用<a href="#使用"><i class="fas fa-hashtag"></i></a></h2></h2><p>于是我写了一个简单的类型用来做自安装。创建完 <code class="language-plaintext highlighter-rouge">SelfInstaller</code> 的实例后，根据安装完的结果做不同的行为：</p><ul><li>显示安装成功的窗口<li>显示正常的窗口<li>关闭自己</ul><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Walterlv.Installing</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Walterlv.ENPlugins.Presentation</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">App</span> <span class="p">:</span> <span class="n">Application</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnStartup</span><span class="p">(</span><span class="n">StartupEventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">base</span><span class="p">.</span><span class="nf">OnStartup</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">installer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SelfInstaller</span><span class="p">(</span><span class="s">@"C:\Users\lvyi\AppData\Local\Walterlv"</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="n">installer</span><span class="p">.</span><span class="nf">TryInstall</span><span class="p">();</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Installed</span><span class="p">:</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Updated</span><span class="p">:</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">UpdatedInUse</span><span class="p">:</span>
                    <span class="k">new</span> <span class="nf">InstallTipWindow</span><span class="p">().</span><span class="nf">Show</span><span class="p">();</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Same</span><span class="p">:</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Ran</span><span class="p">:</span>
                    <span class="k">new</span> <span class="nf">MainWindow</span><span class="p">().</span><span class="nf">Show</span><span class="p">();</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">ShouldRerun</span><span class="p">:</span>
                    <span class="nf">Shutdown</span><span class="p">();</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="附全部源码">附全部源码<a href="#附全部源码"><i class="fas fa-hashtag"></i></a></h2></h2><p>本文代码在 <a href="https://gist.github.com/walterlv/33bdd62e2411c69c2699038e2bc97488">https://gist.github.com/walterlv/33bdd62e2411c69c2699038e2bc97488</a>。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Walterlv.EasiPlugins.Installing</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 自安装或字更新的安装器。</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SelfInstaller</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 初始化 &lt;see cref="SelfInstaller"/&gt; 的新实例。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="targetFilePath"&gt;要安装的主程序的目标路径。&lt;/param&gt;</span>
        <span class="c1">/// &lt;param name="installingProcedure"&gt;如果需要在安装后执行额外的安装步骤，则指定自定义的安装步骤。&lt;/param&gt;</span>
        <span class="k">public</span> <span class="nf">SelfInstaller</span><span class="p">(</span><span class="kt">string</span> <span class="n">targetFilePath</span><span class="p">,</span> <span class="n">IInstallingProcedure</span> <span class="n">installingProcedure</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">assembly</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetCallingAssembly</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">extensionName</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">AssemblyTitleAttribute</span><span class="p">&gt;().</span><span class="n">Title</span><span class="p">;</span>
            <span class="n">TargetFileInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileInfo</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span>
                <span class="n">targetFilePath</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">targetFilePath</span><span class="p">)),</span>
                <span class="n">extensionName</span><span class="p">,</span> <span class="n">extensionName</span> <span class="p">+</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetExtension</span><span class="p">(</span><span class="n">assembly</span><span class="p">.</span><span class="n">Location</span><span class="p">)));</span>
            <span class="n">InstallingProcedure</span> <span class="p">=</span> <span class="n">installingProcedure</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 获取要安装的主程序的目标路径。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">private</span> <span class="n">FileInfo</span> <span class="n">TargetFileInfo</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 获取或设置当应用重新启动自己的时候应该使用的参数。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">RunSelfArguments</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="s">"--rerun-reason {reason}"</span><span class="p">;</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 获取此自安装器安装中需要执行的自定义安装步骤。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="n">IInstallingProcedure</span> <span class="n">InstallingProcedure</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 尝试安装，并返回安装结果。调用者可能需要对安装结果进行必要的操作。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">public</span> <span class="n">InstalledState</span> <span class="nf">TryInstall</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">state0</span> <span class="p">=</span> <span class="nf">InstallOrUpdate</span><span class="p">();</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">state0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// 已安装或更新，由已安装的程序处理安装后操作。</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Installed</span><span class="p">:</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Updated</span><span class="p">:</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">UpdatedInUse</span><span class="p">:</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Same</span><span class="p">:</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">ShouldRerun</span><span class="p">:</span>
                    <span class="n">Process</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="n">TargetFileInfo</span><span class="p">.</span><span class="n">FullName</span><span class="p">,</span> <span class="nf">BuildRerunArguments</span><span class="p">(</span><span class="n">state0</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(),</span> <span class="k">false</span><span class="p">));</span>
                    <span class="k">return</span> <span class="n">state0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">state1</span> <span class="p">=</span> <span class="n">InstallingProcedure</span><span class="p">?.</span><span class="nf">AfterInstall</span><span class="p">(</span><span class="n">TargetFileInfo</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span> <span class="p">??</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Ran</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">state0</span> <span class="k">is</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">UpdatedInUse</span> <span class="p">||</span> <span class="n">state1</span> <span class="k">is</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">UpdatedInUse</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">UpdatedInUse</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">state0</span> <span class="k">is</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Updated</span> <span class="p">||</span> <span class="n">state1</span> <span class="k">is</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Updated</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Updated</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">state0</span> <span class="k">is</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Installed</span> <span class="p">||</span> <span class="n">state1</span> <span class="k">is</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Installed</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Installed</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">state1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 进行安装或更新。执行后将返回安装状态以及安装后的目标程序路径。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">private</span> <span class="n">InstalledState</span> <span class="nf">InstallOrUpdate</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">extensionFilePath</span> <span class="p">=</span> <span class="n">TargetFileInfo</span><span class="p">.</span><span class="n">FullName</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">selfFilePath</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">().</span><span class="n">Location</span><span class="p">;</span>

            <span class="c1">// 判断当前是否已经运行在插件目录下。如果已经在那里运行，那么不需要安装。</span>
            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">extensionFilePath</span><span class="p">,</span> <span class="n">selfFilePath</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">// 继续运行自己即可。</span>
                <span class="k">return</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Ran</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 判断插件目录下的软件版本是否比较新，如果插件目录已经比较新，那么不需要安装。</span>
            <span class="kt">var</span> <span class="n">isOldOneExists</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">extensionFilePath</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isOldOneExists</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">isNewer</span> <span class="p">=</span> <span class="nf">CheckIfNewer</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">isNewer</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// 运行已安装目录下的自己。</span>
                    <span class="k">return</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Same</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// 将自己复制到插件目录进行安装。</span>
            <span class="kt">var</span> <span class="n">succeedOnce</span> <span class="p">=</span> <span class="nf">CopySelfToInstall</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">succeedOnce</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// 如果不是一次就成功，说明目标被占用。</span>
                <span class="k">return</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">UpdatedInUse</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">isOldOneExists</span> <span class="p">?</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Updated</span> <span class="p">:</span> <span class="n">InstalledState</span><span class="p">.</span><span class="n">Installed</span><span class="p">;</span>

            <span class="kt">bool</span> <span class="nf">CheckIfNewer</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">Version</span> <span class="n">installedVersion</span><span class="p">;</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">installed</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">ReflectionOnlyLoadFrom</span><span class="p">(</span><span class="n">extensionFilePath</span><span class="p">);</span>

                    <span class="kt">var</span> <span class="n">installedVersionString</span> <span class="p">=</span>
                        <span class="n">installed</span><span class="p">.</span><span class="nf">GetCustomAttributesData</span><span class="p">()</span>
                            <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span>
                                <span class="n">x</span><span class="p">.</span><span class="n">AttributeType</span><span class="p">.</span><span class="n">FullName</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">AssemblyFileVersionAttribute</span><span class="p">).</span><span class="n">FullName</span><span class="p">)</span>
                            <span class="p">?.</span><span class="n">ConstructorArguments</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Value</span> <span class="k">as</span> <span class="kt">string</span> <span class="p">??</span> <span class="s">"0.0"</span><span class="p">;</span>
                    <span class="n">installedVersion</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Version</span><span class="p">(</span><span class="n">installedVersionString</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">FileLoadException</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">installedVersion</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Version</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">BadImageFormatException</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">installedVersion</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Version</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="kt">var</span> <span class="n">current</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">currentVersionString</span> <span class="p">=</span>
                    <span class="n">current</span><span class="p">.</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">AssemblyFileVersionAttribute</span><span class="p">&gt;()?.</span><span class="n">Version</span> <span class="p">??</span> <span class="s">"0.0"</span><span class="p">;</span>
                <span class="kt">var</span> <span class="n">currentVersion</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Version</span><span class="p">(</span><span class="n">currentVersionString</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">currentVersion</span> <span class="p">&gt;</span> <span class="n">installedVersion</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 将自己复制到目标安装路径。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">private</span> <span class="kt">bool</span> <span class="nf">CopySelfToInstall</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">extensionFolder</span> <span class="p">=</span> <span class="n">TargetFileInfo</span><span class="p">.</span><span class="n">Directory</span><span class="p">.</span><span class="n">FullName</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">extensionFilePath</span> <span class="p">=</span> <span class="n">TargetFileInfo</span><span class="p">.</span><span class="n">FullName</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">selfFilePath</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">().</span><span class="n">Location</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(!</span><span class="n">Directory</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">extensionFolder</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Directory</span><span class="p">.</span><span class="nf">CreateDirectory</span><span class="p">(</span><span class="n">extensionFolder</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">isInUse</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="kt">int</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">File</span><span class="p">.</span><span class="nf">Move</span><span class="p">(</span><span class="n">extensionFilePath</span><span class="p">,</span> <span class="n">extensionFilePath</span> <span class="p">+</span> <span class="s">$".</span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="s">.bak"</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="n">File</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">selfFilePath</span><span class="p">,</span> <span class="n">extensionFilePath</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
                    <span class="k">return</span> <span class="p">!</span><span class="n">isInUse</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// 不退出循环，于是会重试。</span>
                    <span class="n">isInUse</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="p">!</span><span class="n">isInUse</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 生成用于重启自身的启动参数。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="rerunReason"&gt;表示重启原因的一个单词（不能包含空格）。&lt;/param&gt;</span>
        <span class="c1">/// &lt;param name="includeExecutablePath"&gt;&lt;/param&gt;</span>
        <span class="c1">/// &lt;param name="executablePath"&gt;&lt;/param&gt;</span>
        <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="nf">BuildRerunArguments</span><span class="p">(</span><span class="kt">string</span> <span class="n">rerunReason</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">includeExecutablePath</span><span class="p">,</span> <span class="kt">string</span> <span class="n">executablePath</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rerunReason</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">rerunReason</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">rerunReason</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">" "</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"重启原因不能包含空格"</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">rerunReason</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">args</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">includeExecutablePath</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">args</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">executablePath</span><span class="p">)</span>
                    <span class="p">?</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetEntryAssembly</span><span class="p">().</span><span class="n">Location</span>
                    <span class="p">:</span> <span class="n">executablePath</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">RunSelfArguments</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">args</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">RunSelfArguments</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"{reason}"</span><span class="p">,</span> <span class="n">rerunReason</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 表示安装完后的状态。</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">enum</span> <span class="n">InstalledState</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 已安装。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="n">Installed</span><span class="p">,</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 已更新。说明运行此程序时，已经存在一个旧版本的应用。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="n">Updated</span><span class="p">,</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 已更新。但是原始文件被占用，可能需要重启才可使用。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="n">UpdatedInUse</span><span class="p">,</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 已代理启动新的程序，所以此程序需要退出。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="n">ShouldRerun</span><span class="p">,</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 两个程序都是一样的，跑谁都一样。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="n">Same</span><span class="p">,</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 没有执行安装、更新或代理，表示此程序现在是正常启动。</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="n">Ran</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p> 本文会经常更新，请阅读原文： <a href="/post/simple-windows-app-self-installer.html">https://blog.walterlv.com/post/simple-windows-app-self-installer.html</a> ，以避免陈旧错误知识的误导，同时有更好的阅读体验。</p><p> <a rel="知识共享许可协议" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="知识共享许可协议" src="https://blog.walterlv.com/assets/img/by-nc-sa.svg" /> </a></p><p> 本作品采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可。欢迎转载、使用、重新发布，但务必保留文章署名 吕毅 （包含链接： <a href="https://blog.walterlv.com">https://blog.walterlv.com</a> ），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。如有任何疑问，请 <a href="mailto:walter.lv@qq.com">与我联系 (walter.lv@qq.com)</a> 。</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="comments-wrapper"> 登录 GitHub 账号进行评论</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=制作一个极简的 .NET 客户端应用自安装或自更新程序 - walterlv&url=https://blog.walterlv.com/post/simple-windows-app-self-installer.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=制作一个极简的 .NET 客户端应用自安装或自更新程序 - walterlv&u=https://blog.walterlv.com/post/simple-windows-app-self-installer.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=制作一个极简的 .NET 客户端应用自安装或自更新程序 - walterlv&url=https://blog.walterlv.com/post/simple-windows-app-self-installer.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/post/monitor-foreground-window-on-windows">如何在控制台程序中监听 Windows 前台窗口的变化</a><li><a href="/post/how-to-start-a-process-with-environment-variables-without-code">在 Windows 上如何在启动程序时单独为这个程序指定环境变量，而不需要编写任何代码或脚本</a><li><a href="/post/wpf-draw-a-hsl-hsb-palette-using-hlsl">WPF 像素着色器进阶：使用 HLSL 编写一个高性能的实时变化的 HSL/HSV/HSB 调色盘</a><li><a href="/post/create-wpf-pixel-shader-effects-using-shazzam-shader-editor.html">WPF 像素着色器入门：使用 Shazzam Shader Editor 编写 HLSL 像素着色器代码</a><li><a href="/post/where-is-the-windows-10-native-icons.html">Windows 10 自带那么多图标，去哪里找呢？</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><section class="comments"> <script src="https://utteranc.es/client.js" repo="walterlv/BlogComments" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></section></div></div></div><footer class="d-flex flex-column w-100 justify-content-center"><div id="analytics-box"> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-108101550-1"></script> <script> document.addEventListener("DOMContentLoaded", function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-108101550-1'); }); </script> <script async type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1264408226'%3E%3C/span%3E%3Cscript src='//s22.cnzz.com/z_stat.php%3Fid%3D1264408226%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2014-2024 <a href="https://github.com/walterlv">walterlv</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由吕毅按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，基于 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题修改。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
