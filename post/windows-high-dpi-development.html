<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32）" /><meta name="author" content="吕毅" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="本文将介绍 Windows 系统中高 DPI 开发的基础知识。由于涉及到坐标转换，这种转换经常发生在计算的不知不觉中；所以无论你使用哪种 Windows 下的 UI 框架进行开发，你都需要了解这些内容，以免不断踩坑。" /><meta property="og:description" content="本文将介绍 Windows 系统中高 DPI 开发的基础知识。由于涉及到坐标转换，这种转换经常发生在计算的不知不觉中；所以无论你使用哪种 Windows 下的 UI 框架进行开发，你都需要了解这些内容，以免不断踩坑。" /><link rel="canonical" href="https://blog.walterlv.com/post/windows-high-dpi-development.html" /><meta property="og:url" content="https://blog.walterlv.com/post/windows-high-dpi-development.html" /><meta property="og:site_name" content="walterlv" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-04T20:33:15+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32）" /><meta name="twitter:site" content="@_lvyi_" /><meta name="twitter:creator" content="@吕毅" /> <script type="application/ld+json"> {"datePublished":"2021-01-04T20:33:15+08:00","description":"本文将介绍 Windows 系统中高 DPI 开发的基础知识。由于涉及到坐标转换，这种转换经常发生在计算的不知不觉中；所以无论你使用哪种 Windows 下的 UI 框架进行开发，你都需要了解这些内容，以免不断踩坑。","dateModified":"2021-12-20T00:40:29+08:00","headline":"Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32）","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.walterlv.com/post/windows-high-dpi-development.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.walterlv.com/assets/img/logo.png"},"name":"吕毅"},"url":"https://blog.walterlv.com/post/windows-high-dpi-development.html","author":{"@type":"Person","name":"吕毅"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32） - walterlv</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="walterlv"><meta name="application-name" content="walterlv"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="page-bluring-bg" style=" background-image: url('/static/posts/2018-10-22-15-53-59.png'); "></div><div id="topbar-wrapper" class="row topbar-down"><div id="topbar" class="col-12 d-flex h-100 align-items-center"><div id="topbar-logoside" class="col"> <a id="topbar-logo" href="https://blog.walterlv.com" alt="avatar"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <a id="topbar-title" class="site-title" href="https://blog.walterlv.com" alt="walterlv"> walterlv </a></div><div id="topbar-searchside" class="justify-content-center col-5"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div><div class="col"></div></div></div><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="sidebar-box post-item-box profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">吕毅</a></div><div class="site-subtitle font-italic">.NET and Windows App Developer, Microsoft MVP</div></div><ul class="sidebar-box post-item-box"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/friends/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>朋友和收藏</span> </a><li class="nav-item"> <a href="/mind/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>胡思乱想</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/walterlv" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_lvyi_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['walter.lv','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32）</h1><div class="post-meta text-muted"><div class="d-flex"> <span> 吕毅 </span> <span> 发表于 <em class="timeago" date="2018-10-18 10:06:11 +0800" data-toggle="tooltip" data-placement="bottom" title="2018-10-18, 10:06 +0800" >2018-10-18</em> </span> <span> 更新于 <em class="timeago" date="2021-01-04 20:33:15 +0800" data-toggle="tooltip" data-placement="bottom" title="2021-01-04, 20:33 +0800" >2021-01-04</em> </span></div></div><div class="post-content"><p>本文将介绍 Windows 系统中高 DPI 开发的基础知识。由于涉及到坐标转换，这种转换经常发生在计算的不知不觉中；所以无论你使用哪种 Windows 下的 UI 框架进行开发，你都需要了解这些内容，以免不断踩坑。</p><hr /><p><a href="https://r302.cc/D58kdD"><img data-proofer-ignore data-src="/static/posts/2018-10-22-15-53-59.png" alt="Windows 高 DPI 应用开发课件" /></a></p><div id="toc"></div><h2 id="各种不同的-windows-桌面-ui-框架">各种不同的 Windows 桌面 UI 框架<a href="#各种不同的-windows-桌面-ui-框架"><i class="fas fa-hashtag"></i></a></h2></h2><p>微软主推的 Windows 桌面 UI 框架有：</p><ul><li>UWP<li>WPF<li>Windows Forms<li>Win32 与 C++<li>DirectX</ul><p>后两者实际上并不是 UI 框架，是 UI 框架的底层不同实现。当然你单纯凭借 Win32 和 DirectX 去开发 GUI 应用也没有人拦你，只不过如果你试图只用 Win32 和 DirectX 而不进行各种 UI 组件封装的话，最终会非常痛苦的。</p><p>UWP 只支持 Windows 10（当然也分不同的小版本，兼容起来有些小麻烦）。</p><p>WPF 和 Windows Forms 的最新版本只支持 Windows 7 SP1 及以上系统。<em>如果要支持 Windows 7 和更早的系统，你需要降低 .NET Framework 的版本至 4.5.2 及以下；如果要 XP 支持，还需要到 4.0 及以下。</em></p><h2 id="对普通用户而言的-dpi-级别">对普通用户而言的 DPI 级别<a href="#对普通用户而言的-dpi-级别"><i class="fas fa-hashtag"></i></a></h2></h2><p>DPI 值有两种：系统 DPI (System DPI) 和屏幕 DPI (Monitor DPI)。自 Windows Vista 开始引入系统 DPI 概念，自 Windows 8.1 开始引入屏幕 DPI 概念。</p><p>在 Windows Vista / 7 / 8 中，操作系统提供了真正的 DPI 的设置：</p><p><img data-proofer-ignore data-src="/static/posts/2021-01-04-20-25-29.png" alt="Windows 7 的 DPI 设置" /><br /> ▲ Windows 7 的 DPI 设置（<em>控制面板 -&gt; 外观与个性化 -&gt; 显示</em>）</p><p>这里的设置改的就是系统的 DPI 值。</p><p>Windows 7 中还额外提供了传统 Windows XP 风格 DPI 缩放比例的选项（此选项在 Windows 8 之后就删掉了），这也是在修改 DPI 值，只不过可以选择非 1/4 整数倍的 DPI 值。</p><p><img data-proofer-ignore data-src="/static/posts/2021-01-04-20-26-22.png" alt="自定义 DPI 设置" /><br /> ▲ 自定义 DPI 设置</p><p>自 Windows 8.1 开始，操作系统开始可以设置不同屏幕的 DPI 值了：</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-17-18-15-37.png" alt="Windows 10 中的多个屏幕选择" /><br /> ▲ Windows 10 中的多个屏幕选择</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-17-18-15-59.png" alt="Windows 10 中针对每个屏幕的 DPI 设置" /><br /> ▲ Windows 10 中针对每个屏幕的 DPI 设置</p><p>如果用户在设置中更改了系统 DPI 值或屏幕 DPI 值，那么 Windows 系统会提示需要注销才会应用修改。</p><p>对于 Windows 8.1 以下的系统，注销是必要的。因为系统 DPI 值如果不注销就不会改变，应用需要在系统重新登录后有了新的 DPI 值时才会正常根据新的系统 DPI 值进行渲染。否则就是系统进行的位图缩放。</p><p>对于 Windows 8.1 及以上的系统，注销通常也是必要的。虽然屏幕 DPI 值已经更新，并且已向应用窗口发送了 Dpi Change 消息，但系统 DPI 值依然没变。应用必须处理 Dpi Change 消息才会正常渲染。如果应用不支持屏幕 DPI 感知，那么使用的就是系统 DPI 值，于是一样的会被系统进行位图缩放。</p><p>但事情到 Windows 10 (1803) 之后，事情又有了转机。现在，你可以通过在设置中打开一个开关，使得无需注销，只要重新打开应用即可让此应用获取到最新的系统 DPI 的值。</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-28-11-03-11.png" alt="Windows 10 (1803) 中新增的“不模糊”设置项" /></p><p>方法是：打开“设置” -&gt; “系统” -&gt; “显示器” -&gt; “高级缩放设置”，在“高级缩放设置”上，打开“允许 Windows 尝试修复应用，使其不模糊”。</p><p>额外的，对于 Windows 8.1 及以上的系统，系统 DPI 值等于主屏在系统启动时的屏幕 DPI 值。</p><h2 id="对-windows-应用而言的-dpi-感知级别dpi-awareness">对 Windows 应用而言的 DPI 感知级别（Dpi Awareness）<a href="#对-windows-应用而言的-dpi-感知级别dpi-awareness"><i class="fas fa-hashtag"></i></a></h2></h2><p>Windows 的 DPI 感知级别经过历代升级，已经有四种了。</p><ol><li>无感知 (<strong>Unaware</strong>)<ul><li>DPI 值就是一个常量 96。<li>如果在系统中设置缩放，那么就会采用位图拉伸（会模糊）。<li>更多信息请看本文末尾的故事。</ul><li>系统级感知 (<strong>System DPI Awareness</strong>)<ul><li>Vista 系统引入。<li>所有显示器上的应用共用这一个 DPI 值。<li>每个用户会话固定一个 DPI 值，修改 DPI 后不需要重启系统而只需要注销当前用户重新登录即可。<li>如果在设置中修改了 DPI，那么就会采用位图拉伸（会模糊）。</ul><li>屏幕级感知 (<strong>Per-Monitor DPI Awareness</strong>)<ul><li>随 Windows 8.1 引入<li>应用的 DPI 值会随着所在屏幕的不同而改变。<li>当多个屏幕 DPI 不一样，而应用从一个屏幕切换到另一个屏幕的时候，应用会收到 DPI 改变的消息<li>只有应用的顶层 HWND 会收到 DPI 改变消息</ul><li>屏幕级感知第二代 (<strong>Per-Monitor V2 DPI Awareness</strong>)<ul><li>随 Windows 10 (1607) 引入<li>应用的 DPI 值会随着所在屏幕的不同而改变。<li>当多个屏幕 DPI 不一样，而应用从一个屏幕切换到另一个屏幕的时候，应用会收到 DPI 改变的消息<li>应用的顶层和子 HWND 都会收到 DPI 改变消息<li>以下 UI 元素也会在 DPI 改变时缩放<ul><li>非客户区（Non-client Area）<li>系统通用控件中的位图（comctl32V6）<li>对话框（<a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-createdialoga?wt.mc_id=MVP">CreateDialog</a>）</ul></ul></ol><p>在 Windows 10 19H1 中，可以直接在任务管理器中查看到进程的 DPI Awareness：</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-22-15-47-00.png" alt="在任务管理器中查看 DPI Awareness" /><br /> ▲ 在任务管理器中查看 DPI Awareness</p><p>方法是在任务管理器中 Details 的标题栏右键，选择列，然后找到 DPI Awareness。</p><p>可以看到，目前仅文件资源管理器是 Per-Monitor V2 的。</p><p>关于在任务管理器中查看 DPI，可以阅读我的另一篇博客：</p><ul><li><a href="/post/view-process-info-using-task-manager">Windows 系统上使用任务管理器查看进程的各项属性（命令行、DPI、管理员权限等） - 吕毅</a></ul><p>任务管理器上关于 DPI 的中文翻译也是蛮有意思的。</p><h2 id="不同-ui-框架对-dpi-的支持情况">不同 UI 框架对 DPI 的支持情况<a href="#不同-ui-框架对-dpi-的支持情况"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="uwp">UWP<a href="#uwp"><i class="fas fa-hashtag"></i></a></h3></h3><p>UWP 当然支持最新的各种 DPI 感知级别，而且是完全支持。</p><h3 id="wpf">WPF<a href="#wpf"><i class="fas fa-hashtag"></i></a></h3></h3><p>WPF 的最新版支持最新的 DPI 感知级别，不过依然有限制：</p><blockquote><p>Native WPF applications will DPI scale WPF hosted in other frameworks and other frameworks hosted in WPF do not automatically scale</p></blockquote><p>即原生 WPF 应用支持 DPI 缩放，在其他 UI 框架中的 WPF 也支持 DPI 缩放；但是 WPF 中嵌入的其他 UI 框架不支持自动 DPI 缩放。</p><p>WPF 第一个版本（随 .NET Framework 3.5 发布）就已支持系统级 DPI 感知。</p><p>.NET Framework 4.6.2 开始的 WPF 才开始支持屏幕级 DPI 感知。而 Per-Monitor V1 和 Per-Monitor V2 的支持在操作系统级别是兼容的，所以只需要修改 WPF 中的应用程序清单即可兼容第二代屏幕级 DPI 感知。</p><h3 id="windows-forms">Windows Forms<a href="#windows-forms"><i class="fas fa-hashtag"></i></a></h3></h3><p>Windows Forms 也是在 .NET Framework 4.7 才开始支持屏幕级 DPI 感知的。不过部分控件不支持自动随屏幕 DPI 切换。</p><h3 id="其他-ui-框架">其他 UI 框架<a href="#其他-ui-框架"><i class="fas fa-hashtag"></i></a></h3></h3><p>原生 Win32 是支持最新 DPI 感知的，其他如 GDI/GDI+/MFC 等都不支持，除非开发者手工编写。</p><h2 id="混合-dpi-感知级别">混合 DPI 感知级别<a href="#混合-dpi-感知级别"><i class="fas fa-hashtag"></i></a></h2></h2><p>当项目足够大的时候，一个或几个项目成员可能很难了解所有的窗口逻辑。让一个进程的所有窗口开启 DPI 缩放对应用的高 DPI 迁移来说比较困难。不过好在我们可以开启混合 DPI 缩放。</p><p>Windows 10 (1604) 开始引入顶级窗口（Top-level Window）级别的 DPI 感知，而 Windows 10 (1703) 开始引入每一个 HWND 的 DPI 感知，包括顶级窗口和非顶级窗口。这里的顶级窗口指的是没有父级的窗口，指的是 Parent，而不是 Owner。（实际上 API 在更早版本就引入了，这里有故事，详见本文末尾。）</p><p>在创建一个窗口的前后分别调用 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/Winuser/nf-winuser-setthreaddpiawarenesscontext?wt.mc_id=MVP">SetThreadDpiAwarenessContext</a> 函数可以让创建的这个窗口具有单独的 DPI 感知级别。前一次是为了让窗口在创建时有一个对此线程的新的 DPI 感知级别，而后一次调用是恢复此线程的 DPI 感知级别。</p><p>关于混合 DPI 感知级别的其他内容，可以阅读官网：<a href="https://docs.microsoft.com/en-us/windows/desktop/hidpi/high-dpi-improvements-for-desktop-applications?wt.mc_id=MVP">Mixed-Mode DPI Scaling and DPI-aware APIs - Microsoft Docs</a>。</p><p>微软的 Office 系列就是典型的使用了混合 DPI 感知级别的应用。在以下实验中，我组成了一个 96 DPI 的主屏和 144 DPI 的副屏，先在 96 DPI 的屏幕上截一张图，再将窗口移动到 144 DPI 的屏幕中再截一张图。</p><p>Microsoft PowerPoint 使用的是系统 DPI 感知级别：</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-18-10-10-29.png" alt="96 DPI 下的主界面" /><br /> ▲ 96 DPI 下的主界面</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-18-10-11-03.png" alt="144 DPI 下的主界面" /><br /> ▲ 144 DPI 下的主界面</p><p>你可以通过点开图片查看原图来比较这两幅图在原图尺寸下的模糊程度。</p><p>Microsoft PowerPoint 的演示页面使用的是屏幕 DPI 感知级别：</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-18-10-13-43.png" alt="96 DPI 下的演示页面" /><br /> ▲ 96 DPI 下的演示页面</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-18-10-14-09.png" alt="144 DPI 下的演示页面" /><br /> ▲ 144 DPI 下的演示页面</p><p>可以看到，演示页面在多屏 DPI 下是没有产生缩放的模糊，即采用了屏幕 DPI 感知级别。</p><p>而以上的主界面和演示页面属于同一个进程。</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-18-10-17-29.png" alt="只有一个 PowerPoint 进程" /><br /> ▲ 只有一个 PowerPoint 进程</p><h2 id="dpi-相关的-windows-api-的迁移">DPI 相关的 Windows API 的迁移<a href="#dpi-相关的-windows-api-的迁移"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>GetSystemMetrics -&gt; GetSystemMetricsForDpi<li>AdjustWindowRectEx -&gt; AdjustWindowRectExForDpi<li>SystemParametersInfo -&gt; SystemParametersInfoForDpi<li>GetDpiForMonitor -&gt; GetDpiForWindow</ul><h2 id="关于-dpi-相关-api-变化的故事">关于 DPI 相关 API 变化的故事<a href="#关于-dpi-相关-api-变化的故事"><i class="fas fa-hashtag"></i></a></h2></h2><p>感谢 <a href="https://www.52pojie.cn/home.php?mod=space&amp;uid=512260">Mouri_Naruto</a>（毛利）提供的故事，API 的具体使用也可参考他的文章：<a href="https://www.52pojie.cn/thread-512713-1-1.html">【原创】实现每显示器高DPI识别(Per-Monitor DPI Aware)的注意事项</a>。</p><h3 id="关于-windows-10">关于 Windows 10<a href="#关于-windows-10"><i class="fas fa-hashtag"></i></a></h3></h3><p>前文提到 Per-Monitor V2 是 Windows 10 (1703) 引入的，微软官方文档 <a href="https://docs.microsoft.com/en-us/windows/win32/hidpi/high-dpi-desktop-application-development-on-windows">High DPI Desktop Application Development on Windows - Win32 apps</a> 也是这么写的。但实际上更早的 Windows 10 (1607) 就引入了相关 API，包括 SetThreadDpiAwarenessContext 和 PerMonitorV2 应用程序清单。并且更早的，V2 带来的非客户区缩放和子窗口 DPI 变更消息的 API 在 1507 和 1511（分别是 Windows 10 的第一和第二个正式版本）就已经有了，不过是未公开的（可参阅 <a href="https://www.52pojie.cn/thread-512713-1-1.html">【原创】实现每显示器高DPI识别(Per-Monitor DPI Aware)的注意事项</a>）。1607 开始这两个非公开 API 不能使用了，因为换成了新的 API，参见 <a href="https://docs.microsoft.com/en-us/windows/win32/hidpi/setting-the-default-dpi-awareness-for-a-process#setting-default-awareness-with-the-application-manifest">Setting the default DPI awareness for a process (Windows) - Win32 apps</a>。</p><p>可以发现微软实际上宣称 1607 已经支持 Per-Monitor V2 了，而完整支持是在 1703。所谓的“完整”体现在这些地方：</p><ul><li>comctl32 从 1703 开始完整支持缩放（参见 <a href="https://blogs.windows.com/windowsdeveloper/2016/10/24/high-dpi-scaling-improvements-for-desktop-applications-and-mixed-mode-dpi-scaling-in-the-windows-10-anniversary-update/#ioIsJTATkKKMored.97">High DPI Scaling Improvements for Desktop Applications and “Mixed Mode” DPI Scaling in the Windows 10 Anniversary Update (1607) - Windows Developer Blog</a>）<li>如果你指定了 PerMonitor 但没指定 PerMonitorV2，那么 1607 默认是 PerMonitor，1703 默认是 PerMonitorV2。</ul><h3 id="关于-windows-vista-之前的系统">关于 Windows Vista 之前的系统<a href="#关于-windows-vista-之前的系统"><i class="fas fa-hashtag"></i></a></h3></h3><p>感谢 <a href="https://www.52pojie.cn/home.php?mod=space&amp;uid=512260">Mouri_Naruto</a>（毛利）提供的历史：</p><blockquote><p>Windows Vista 之前的系统不代表就对 DPI 无感知，事实上 Windows Vista 之前的版本，大概是 Windows 98 开始就支持通过 GDI 相关的 API 获取当前系统的 DPI 值（当时 Windows Phone 之前的 Windows 移动端 OS 通过这种 API 支持 PPI 高达 280 的手机屏幕，毕竟我也算是 2008 年就入手 HTC Touch Diamond 的用户，那个屏幕的 PPI 值（PPI 280）直到 iPhone Retina 概念（PPI 320）出现后才超过）。</p><p>只是 Windows Vista 提供了对不明确表示 DPI 支持的应用的暴力缩放（通过 Desktop Window Manager 合成实现），毕竟那个时代除了手机之外，基本没有什么屏幕涉及到高 DPI。</p><p>倒是 Windows Vista 之前的系统的 DPI 修改是需要重启机器的……所以当时我作死给我的手机修改 DPI 也是要重启的（Windows CE 5.2 内核）</p><p>Vista 之前的版本，系统中设置缩放，如果你做到了 System Aware 的要求位图是不会模糊的（Vista 引入 DWM 虚拟化强制拉伸，主要是当时的引用没有做相关支持，在高 DPI 情况下会控件会变得非常小且布局大概率会乱掉）。</p></blockquote><hr /><p><strong>参考资料</strong></p><ul><li><a href="https://docs.microsoft.com/en-us/windows/desktop/hidpi/high-dpi-desktop-application-development-on-windows?wt.mc_id=MVP">High DPI Desktop Application Development on Windows - Microsoft Docs</a><li><a href="https://github.com/Microsoft/WPF-Samples/blob/master/PerMonitorDPI/Developer%20Guide%20-%20Per%20Monitor%20DPI%20-%20WPF%20Preview.docx">WPF-Samples/Developer Guide - Per Monitor DPI - WPF Preview.docx at master · Microsoft/WPF-Samples</a><li><a href="https://support.microsoft.com/zh-cn/help/4091364/windows-10-fix-blurry-apps">在 Windows 10 中修复显示模糊的应用 - Windows Help</a><li><a href="https://support.microsoft.com/en-us/help/4091364/windows-10-fix-blurry-apps">Fix apps that appear blurry in Windows 10 - Windows Help</a></ul><p> 本文会经常更新，请阅读原文： <a href="/post/windows-high-dpi-development.html">https://blog.walterlv.com/post/windows-high-dpi-development.html</a> ，以避免陈旧错误知识的误导，同时有更好的阅读体验。</p><p> <a rel="知识共享许可协议" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="知识共享许可协议" src="https://blog.walterlv.com/assets/img/by-nc-sa.svg" /> </a></p><p> 本作品采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可。欢迎转载、使用、重新发布，但务必保留文章署名 吕毅 （包含链接： <a href="https://blog.walterlv.com">https://blog.walterlv.com</a> ），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。如有任何疑问，请 <a href="mailto:walter.lv@qq.com">与我联系 (walter.lv@qq.com)</a> 。</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="comments-wrapper"> 登录 GitHub 账号进行评论</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32） - walterlv&url=https://blog.walterlv.com/post/windows-high-dpi-development.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32） - walterlv&u=https://blog.walterlv.com/post/windows-high-dpi-development.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32） - walterlv&url=https://blog.walterlv.com/post/windows-high-dpi-development.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/post/monitor-foreground-window-on-windows">如何在控制台程序中监听 Windows 前台窗口的变化</a><li><a href="/post/how-to-start-a-process-with-environment-variables-without-code">在 Windows 上如何在启动程序时单独为这个程序指定环境变量，而不需要编写任何代码或脚本</a><li><a href="/post/wpf-draw-a-hsl-hsb-palette-using-hlsl">WPF 像素着色器进阶：使用 HLSL 编写一个高性能的实时变化的 HSL/HSV/HSB 调色盘</a><li><a href="/post/create-wpf-pixel-shader-effects-using-shazzam-shader-editor.html">WPF 像素着色器入门：使用 Shazzam Shader Editor 编写 HLSL 像素着色器代码</a><li><a href="/post/where-is-the-windows-10-native-icons.html">Windows 10 自带那么多图标，去哪里找呢？</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><section class="comments"> <script src="https://utteranc.es/client.js" repo="walterlv/BlogComments" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></section></div></div></div><footer class="d-flex flex-column w-100 justify-content-center"><div id="analytics-box"> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-108101550-1"></script> <script> document.addEventListener("DOMContentLoaded", function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-108101550-1'); }); </script> <script async type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1264408226'%3E%3C/span%3E%3Cscript src='//s22.cnzz.com/z_stat.php%3Fid%3D1264408226%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2014-2024 <a href="https://github.com/walterlv">walterlv</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由吕毅按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，基于 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题修改。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
