<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null" /><meta name="author" content="吕毅" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="在 WPF 程序中，可能会存在 Application.Current.Dispatcher.Xxx 这样的代码让一部分逻辑回到主 UI 线程。因为发现在调用这句代码的时候出现了 NullReferenceException，于是就有三位小伙伴告诉我说 Current 和 Dispatcher 属性都可能为 null。 然而实际上这里只可能 Current 为 null 而此上下文的 Dispatcher 是绝对不会为 null 的。（当然我们这里讨论的是常规编程手段，如果非常规手段，你甚至可以让实例的 this 为 null 呢……）" /><meta property="og:description" content="在 WPF 程序中，可能会存在 Application.Current.Dispatcher.Xxx 这样的代码让一部分逻辑回到主 UI 线程。因为发现在调用这句代码的时候出现了 NullReferenceException，于是就有三位小伙伴告诉我说 Current 和 Dispatcher 属性都可能为 null。 然而实际上这里只可能 Current 为 null 而此上下文的 Dispatcher 是绝对不会为 null 的。（当然我们这里讨论的是常规编程手段，如果非常规手段，你甚至可以让实例的 this 为 null 呢……）" /><link rel="canonical" href="https://blog.walterlv.com/post/application-dispatcher-will-never-be-null.html" /><meta property="og:url" content="https://blog.walterlv.com/post/application-dispatcher-will-never-be-null.html" /><meta property="og:site_name" content="walterlv" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-08-27T12:51:43+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null" /><meta name="twitter:site" content="@_lvyi_" /><meta name="twitter:creator" content="@吕毅" /> <script type="application/ld+json"> {"datePublished":"2019-08-27T12:51:43+08:00","description":"在 WPF 程序中，可能会存在 Application.Current.Dispatcher.Xxx 这样的代码让一部分逻辑回到主 UI 线程。因为发现在调用这句代码的时候出现了 NullReferenceException，于是就有三位小伙伴告诉我说 Current 和 Dispatcher 属性都可能为 null。 然而实际上这里只可能 Current 为 null 而此上下文的 Dispatcher 是绝对不会为 null 的。（当然我们这里讨论的是常规编程手段，如果非常规手段，你甚至可以让实例的 this 为 null 呢……）","dateModified":"2021-12-20T00:40:29+08:00","headline":"WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.walterlv.com/post/application-dispatcher-will-never-be-null.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.walterlv.com/assets/img/logo.png"},"name":"吕毅"},"url":"https://blog.walterlv.com/post/application-dispatcher-will-never-be-null.html","author":{"@type":"Person","name":"吕毅"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null - walterlv</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="walterlv"><meta name="application-name" content="walterlv"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="topbar-wrapper" class="row topbar-down"><div id="topbar" class="col-12 d-flex h-100 align-items-center"><div id="topbar-logoside" class="col"> <a id="topbar-logo" href="https://blog.walterlv.com" alt="avatar"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <a id="topbar-title" class="site-title" href="https://blog.walterlv.com" alt="walterlv"> walterlv </a></div><div id="topbar-searchside" class="justify-content-center col-5"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div><div class="col"></div></div></div><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="sidebar-box post-item-box profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">吕毅</a></div><div class="site-subtitle font-italic">.NET and Windows App Developer, Microsoft MVP</div></div><ul class="sidebar-box post-item-box"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/friends/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>朋友和收藏</span> </a><li class="nav-item"> <a href="/mind/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>胡思乱想</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/walterlv" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_lvyi_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['walter.lv','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null</h1><div class="post-meta text-muted"><div class="d-flex"> <span> 吕毅 </span> <span> 发表于 <em class="timeago" date="2019-08-27 10:10:50 +0800" data-toggle="tooltip" data-placement="bottom" title="2019-08-27, 10:10 +0800" >2019-08-27</em> </span> <span> 更新于 <em class="timeago" date="2019-08-27 12:51:43 +0800" data-toggle="tooltip" data-placement="bottom" title="2019-08-27, 12:51 +0800" >2019-08-27</em> </span></div></div><div class="post-content"><p>在 WPF 程序中，可能会存在 <code class="language-plaintext highlighter-rouge">Application.Current.Dispatcher.Xxx</code> 这样的代码让一部分逻辑回到主 UI 线程。因为发现在调用这句代码的时候出现了 <code class="language-plaintext highlighter-rouge">NullReferenceException</code>，于是就有三位小伙伴告诉我说 <code class="language-plaintext highlighter-rouge">Current</code> 和 <code class="language-plaintext highlighter-rouge">Dispatcher</code> 属性都可能为 <code class="language-plaintext highlighter-rouge">null</code>。</p><p>然而实际上这里只可能 <code class="language-plaintext highlighter-rouge">Current</code> 为 <code class="language-plaintext highlighter-rouge">null</code> 而此上下文的 <code class="language-plaintext highlighter-rouge">Dispatcher</code> 是绝对不会为 <code class="language-plaintext highlighter-rouge">null</code> 的。（当然我们这里讨论的是常规编程手段，如果非常规手段，你甚至可以让实例的 <code class="language-plaintext highlighter-rouge">this</code> 为 <code class="language-plaintext highlighter-rouge">null</code> 呢……）</p><hr /><p>由于本文所述的两个部分都略长，所以拆分成两篇博客，这样更容易理解。</p><ul><li><a href="/post/application-dispatcher-will-never-be-null">WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null</a><li><a href="/post/application-current-may-be-null">WPF 的 Application.Current.Dispatcher 中，为什么 Current 可能为 null</a></ul><div id="toc"></div><h2 id="applicationdispatcher-实例属性"><code class="language-plaintext highlighter-rouge">Application.Dispatcher</code> 实例属性<a href="#applicationdispatcher-实例属性"><i class="fas fa-hashtag"></i></a></h2></h2><p><code class="language-plaintext highlighter-rouge">Application.Dispatcher</code> 实例属性来自于 <code class="language-plaintext highlighter-rouge">DispatcherObject</code>。</p><h3 id="源代码">源代码<a href="#源代码"><i class="fas fa-hashtag"></i></a></h3></h3><p>为了分析此属性是否可能为 <code class="language-plaintext highlighter-rouge">null</code>，我现在将 <code class="language-plaintext highlighter-rouge">DispatcherObject</code> 的全部代码贴在下面：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MS.Internal.WindowsBase</span><span class="p">;</span>               <span class="c1">// FriendAccessAllowed</span>
 
<span class="k">namespace</span> <span class="nn">System.Windows.Threading</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">///     A DispatcherObject is an object associated with a</span>
    <span class="c1">///     &lt;see cref="Dispatcher"/&gt;.  A DispatcherObject instance should</span>
    <span class="c1">///     only be access by the dispatcher's thread.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="c1">/// &lt;remarks&gt;</span>
    <span class="c1">///     Subclasses of &lt;see cref="DispatcherObject"/&gt; should enforce thread</span>
    <span class="c1">///     safety by calling &lt;see cref="VerifyAccess"/&gt; on all their public</span>
    <span class="c1">///     methods to ensure the calling thread is the appropriate thread.</span>
    <span class="c1">///     &lt;para/&gt;</span>
    <span class="c1">///     DispatcherObject cannot be independently instantiated; that is,</span>
    <span class="c1">///     all constructors are protected.</span>
    <span class="c1">/// &lt;/remarks&gt;</span>
    <span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">DispatcherObject</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">///     Returns the &lt;see cref="Dispatcher"/&gt; that this</span>
        <span class="c1">///     &lt;see cref="DispatcherObject"/&gt; is associated with.</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="nf">EditorBrowsable</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="n">EditorBrowsableState</span><span class="p">.</span><span class="n">Advanced</span><span class="p">)]</span>
        <span class="k">public</span> <span class="n">Dispatcher</span> <span class="n">Dispatcher</span>
        <span class="p">{</span>
            <span class="k">get</span>
            <span class="p">{</span>
                <span class="c1">// This property is free-threaded.</span>
 
                <span class="k">return</span> <span class="n">_dispatcher</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
 
        <span class="c1">// This method allows certain derived classes to break the dispatcher affinity</span>
        <span class="c1">// of our objects.</span>
        <span class="p">[</span><span class="n">FriendAccessAllowed</span><span class="p">]</span> <span class="c1">// Built into Base, also used by Framework.</span>
        <span class="k">internal</span> <span class="k">void</span> <span class="nf">DetachFromDispatcher</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_dispatcher</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="c1">// Make this object a "sentinel" - it can be used in equality tests, but should</span>
        <span class="c1">// not be used in any other way.  To enforce this and catch bugs, use a special</span>
        <span class="c1">// sentinel dispatcher, so that calls to CheckAccess and VerifyAccess will</span>
        <span class="c1">// fail;  this will catch most accidental uses of the sentinel.</span>
        <span class="p">[</span><span class="n">FriendAccessAllowed</span><span class="p">]</span> <span class="c1">// Built into Base, also used by Framework.</span>
        <span class="k">internal</span> <span class="k">void</span> <span class="nf">MakeSentinel</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_dispatcher</span> <span class="p">=</span> <span class="nf">EnsureSentinelDispatcher</span><span class="p">();</span>
        <span class="p">}</span>
 
        <span class="k">private</span> <span class="k">static</span> <span class="n">Dispatcher</span> <span class="nf">EnsureSentinelDispatcher</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_sentinelDispatcher</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// lazy creation - the first thread reaching here creates the sentinel</span>
                <span class="c1">// dispatcher, all other threads use it.</span>
                <span class="n">Dispatcher</span> <span class="n">sentinelDispatcher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Dispatcher</span><span class="p">(</span><span class="n">isSentinel</span><span class="p">:</span><span class="k">true</span><span class="p">);</span>
                <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">&lt;</span><span class="n">Dispatcher</span><span class="p">&gt;(</span><span class="k">ref</span> <span class="n">_sentinelDispatcher</span><span class="p">,</span> <span class="n">sentinelDispatcher</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
            <span class="p">}</span>
 
            <span class="k">return</span> <span class="n">_sentinelDispatcher</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">///     Checks that the calling thread has access to this object.</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;remarks&gt;</span>
        <span class="c1">///     Only the dispatcher thread may access DispatcherObjects.</span>
        <span class="c1">///     &lt;p/&gt;</span>
        <span class="c1">///     This method is public so that any thread can probe to</span>
        <span class="c1">///     see if it has access to the DispatcherObject.</span>
        <span class="c1">/// &lt;/remarks&gt;</span>
        <span class="c1">/// &lt;returns&gt;</span>
        <span class="c1">///     True if the calling thread has access to this object.</span>
        <span class="c1">/// &lt;/returns&gt;</span>
        <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="nf">EditorBrowsable</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="n">EditorBrowsableState</span><span class="p">.</span><span class="n">Never</span><span class="p">)]</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">CheckAccess</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// This method is free-threaded.</span>
 
            <span class="kt">bool</span> <span class="n">accessAllowed</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">Dispatcher</span> <span class="n">dispatcher</span> <span class="p">=</span> <span class="n">_dispatcher</span><span class="p">;</span>
 
            <span class="c1">// Note: a DispatcherObject that is not associated with a</span>
            <span class="c1">// dispatcher is considered to be free-threaded.</span>
            <span class="k">if</span><span class="p">(</span><span class="n">dispatcher</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">accessAllowed</span> <span class="p">=</span> <span class="n">dispatcher</span><span class="p">.</span><span class="nf">CheckAccess</span><span class="p">();</span>
            <span class="p">}</span>
 
            <span class="k">return</span> <span class="n">accessAllowed</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">///     Verifies that the calling thread has access to this object.</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;remarks&gt;</span>
        <span class="c1">///     Only the dispatcher thread may access DispatcherObjects.</span>
        <span class="c1">///     &lt;p/&gt;</span>
        <span class="c1">///     This method is public so that derived classes can probe to</span>
        <span class="c1">///     see if the calling thread has access to itself.</span>
        <span class="c1">/// &lt;/remarks&gt;</span>
        <span class="p">[</span><span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="nf">EditorBrowsable</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">ComponentModel</span><span class="p">.</span><span class="n">EditorBrowsableState</span><span class="p">.</span><span class="n">Never</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">VerifyAccess</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// This method is free-threaded.</span>
 
            <span class="n">Dispatcher</span> <span class="n">dispatcher</span> <span class="p">=</span> <span class="n">_dispatcher</span><span class="p">;</span>
 
            <span class="c1">// Note: a DispatcherObject that is not associated with a</span>
            <span class="c1">// dispatcher is considered to be free-threaded.</span>
            <span class="k">if</span><span class="p">(</span><span class="n">dispatcher</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">dispatcher</span><span class="p">.</span><span class="nf">VerifyAccess</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
 
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">///     Instantiate this object associated with the current Dispatcher.</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">protected</span> <span class="nf">DispatcherObject</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_dispatcher</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">CurrentDispatcher</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="k">private</span> <span class="n">Dispatcher</span> <span class="n">_dispatcher</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">Dispatcher</span> <span class="n">_sentinelDispatcher</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>代码来自：<a href="https://referencesource.microsoft.com/#WindowsBase/Base/System/Windows/Threading/DispatcherObject.cs">DispatcherObject.cs</a>。</p><p><code class="language-plaintext highlighter-rouge">Dispatcher</code> 属性仅仅是在获取 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 字段的值，因此我们只需要看 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 字段的赋值时机，以及所有给 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 赋值的代码。</p><p>由于 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 字段是私有字段，所以仅需调查这个类本身即可找到所有的赋值时机。（反射等非常规手段需要排除在外，因为这意味着开发者是逗比——自己闯的祸不能怪 WPF 框架。）</p><h3 id="赋值时机">赋值时机<a href="#赋值时机"><i class="fas fa-hashtag"></i></a></h3></h3><p>先来看看 <code class="language-plaintext highlighter-rouge">dispatcher</code> 字段的赋值时机。</p><p><code class="language-plaintext highlighter-rouge">DispatcherObject</code> 仅有一个构造函数，而这个构造函数中就已经给 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 赋值了，因此其所有的子类的初始化之前，<code class="language-plaintext highlighter-rouge">_dispatcher</code> 就会被赋值。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">protected</span> <span class="nf">DispatcherObject</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">_dispatcher</span> <span class="p">=</span> <span class="n">Dispatcher</span><span class="p">.</span><span class="n">CurrentDispatcher</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>那么所赋的值是否可能为 <code class="language-plaintext highlighter-rouge">null</code> 呢，这就要看 <code class="language-plaintext highlighter-rouge">Dispatcher.CurrentDispatcher</code> 是否可能返回一个 <code class="language-plaintext highlighter-rouge">null</code> 了。</p><p>以下是 <code class="language-plaintext highlighter-rouge">Dispatcher.CurrentDispatcher</code> 的属性获取代码：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="n">Dispatcher</span> <span class="n">CurrentDispatcher</span>
<span class="p">{</span>
    <span class="k">get</span>
    <span class="p">{</span>
        <span class="c1">// Find the dispatcher for this thread.</span>
        <span class="n">Dispatcher</span> <span class="n">currentDispatcher</span> <span class="p">=</span> <span class="nf">FromThread</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">);;</span>

        <span class="c1">// Auto-create the dispatcher if there is no dispatcher for</span>
        <span class="c1">// this thread (if we are allowed to).</span>
        <span class="k">if</span><span class="p">(</span><span class="n">currentDispatcher</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">currentDispatcher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Dispatcher</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">currentDispatcher</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>可以看到，无论前面的方法得到的值是否是 <code class="language-plaintext highlighter-rouge">null</code>，后面都会再给 <code class="language-plaintext highlighter-rouge">currentDispatcher</code> 局部变量赋值一个新创建的实例的。因此，此属性是绝对不会返回 <code class="language-plaintext highlighter-rouge">null</code> 的。</p><p>由此可知，<code class="language-plaintext highlighter-rouge">DispatcherObject</code> 自构造起便拥有一个不为 <code class="language-plaintext highlighter-rouge">null</code> 的 <code class="language-plaintext highlighter-rouge">Dispatcher</code> 属性，其所有子类在初始化之前便会得到不为 <code class="language-plaintext highlighter-rouge">null</code> 的 <code class="language-plaintext highlighter-rouge">Dispatcher</code> 属性。</p><h3 id="后续赋值">后续赋值<a href="#后续赋值"><i class="fas fa-hashtag"></i></a></h3></h3><p>现在我们来看看在初始化完成之后，后面是否有可能将 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 赋值为 null。</p><p>给 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 字段的赋值代码仅有两个：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// This method allows certain derived classes to break the dispatcher affinity</span>
<span class="c1">// of our objects.</span>
<span class="p">[</span><span class="n">FriendAccessAllowed</span><span class="p">]</span> <span class="c1">// Built into Base, also used by Framework.</span>
<span class="k">internal</span> <span class="k">void</span> <span class="nf">DetachFromDispatcher</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">_dispatcher</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Make this object a "sentinel" - it can be used in equality tests, but should</span>
<span class="c1">// not be used in any other way.  To enforce this and catch bugs, use a special</span>
<span class="c1">// sentinel dispatcher, so that calls to CheckAccess and VerifyAccess will</span>
<span class="c1">// fail;  this will catch most accidental uses of the sentinel.</span>
<span class="p">[</span><span class="n">FriendAccessAllowed</span><span class="p">]</span> <span class="c1">// Built into Base, also used by Framework.</span>
<span class="k">internal</span> <span class="k">void</span> <span class="nf">MakeSentinel</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">_dispatcher</span> <span class="p">=</span> <span class="nf">EnsureSentinelDispatcher</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>第一个 <code class="language-plaintext highlighter-rouge">DetachFromDispatcher</code> 很好理解，让 <code class="language-plaintext highlighter-rouge">DispatcherObject</code> 跟 <code class="language-plaintext highlighter-rouge">Dispatcher</code> 无关。在整个 WPF 的代码中，使用此方法的仅有以下 6 处：</p><ul><li><code class="language-plaintext highlighter-rouge">Freezable.Freeze</code> 实例方法<li><code class="language-plaintext highlighter-rouge">BeginStoryboard.Seal</code> 实例方法<li><code class="language-plaintext highlighter-rouge">Style.Seal</code> 实例方法<li><code class="language-plaintext highlighter-rouge">TriggerBase.Seal</code> 实例方法<li><code class="language-plaintext highlighter-rouge">StyleHelper</code> 在 <code class="language-plaintext highlighter-rouge">SealTemplate</code> 静态方法中对 <code class="language-plaintext highlighter-rouge">FrameworkTemplate</code> 类型的实例调用此方法<li><code class="language-plaintext highlighter-rouge">ResourceDictionary</code> 在构造函数中为 <code class="language-plaintext highlighter-rouge">DispatcherObject</code> 类型的 <code class="language-plaintext highlighter-rouge">DummyInheritanceContext</code> 属性调用此方法</ul><p>而 <code class="language-plaintext highlighter-rouge">Application</code> 类型不是以上任何一个类型的子类（<code class="language-plaintext highlighter-rouge">Application</code> 类的直接基类是 <code class="language-plaintext highlighter-rouge">DispatcherObject</code>），因此 <code class="language-plaintext highlighter-rouge">Application</code> 类中的 <code class="language-plaintext highlighter-rouge">Dispatcher</code> 属性不可能因为 <code class="language-plaintext highlighter-rouge">DetachFromDispatcher</code> 方法的调用而被赋值为 <code class="language-plaintext highlighter-rouge">null</code>。</p><p>接下来看看 <code class="language-plaintext highlighter-rouge">MakeSentinel</code> 方法，此方法的作用不如上面方法那样直观，实际上它的作用仅仅为了验证某个方法调用时所在的线程是否是符合预期的（给 <code class="language-plaintext highlighter-rouge">VerifyAccess</code> 和 <code class="language-plaintext highlighter-rouge">CheckAccess</code> 使用）。</p><p>使用此方法的仅有 1 处：</p><ul><li><code class="language-plaintext highlighter-rouge">ItemsControl</code> 所用的 <code class="language-plaintext highlighter-rouge">ItemInfo</code> 类的静态构造函数</ul><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">internal</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyObject</span> <span class="n">SentinelContainer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DependencyObject</span><span class="p">();</span>
<span class="k">internal</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyObject</span> <span class="n">UnresolvedContainer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DependencyObject</span><span class="p">();</span>
<span class="k">internal</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyObject</span> <span class="n">KeyContainer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DependencyObject</span><span class="p">();</span>
<span class="k">internal</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyObject</span> <span class="n">RemovedContainer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DependencyObject</span><span class="p">();</span>

<span class="k">static</span> <span class="nf">ItemInfo</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// mark the special DOs as sentinels.  This helps catch bugs involving</span>
    <span class="c1">// using them accidentally for anything besides equality comparison.</span>
    <span class="n">SentinelContainer</span><span class="p">.</span><span class="nf">MakeSentinel</span><span class="p">();</span>
    <span class="n">UnresolvedContainer</span><span class="p">.</span><span class="nf">MakeSentinel</span><span class="p">();</span>
    <span class="n">KeyContainer</span><span class="p">.</span><span class="nf">MakeSentinel</span><span class="p">();</span>
    <span class="n">RemovedContainer</span><span class="p">.</span><span class="nf">MakeSentinel</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>所有这些使用都与 <code class="language-plaintext highlighter-rouge">Application</code> 无关。</p><h3 id="结论">结论<a href="#结论"><i class="fas fa-hashtag"></i></a></h3></h3><p>总结以上所有的分析：</p><ol><li><code class="language-plaintext highlighter-rouge">Application</code> 类型的实例在初始化之前，<code class="language-plaintext highlighter-rouge">Dispatcher</code> 属性就已经被赋值且不为 <code class="language-plaintext highlighter-rouge">null</code>；<li>所有可能改变 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 属性的常规方法均与 <code class="language-plaintext highlighter-rouge">Application</code> 类型无关；</ol><p>因此，所有常规手段均不会让 <code class="language-plaintext highlighter-rouge">Application</code> 类的 <code class="language-plaintext highlighter-rouge">Dispatcher</code> 属性拿到 <code class="language-plaintext highlighter-rouge">null</code> 值。如果你还说拿到了 <code class="language-plaintext highlighter-rouge">null</code>，那就检查是否有逗比程序员通过反射或其他手段将 <code class="language-plaintext highlighter-rouge">_dispatcher</code> 字段改为了 <code class="language-plaintext highlighter-rouge">null</code> 吧……</p><h2 id="applicationcurrent-静态属性"><code class="language-plaintext highlighter-rouge">Application.Current</code> 静态属性<a href="#applicationcurrent-静态属性"><i class="fas fa-hashtag"></i></a></h2></h2><p>关于 <code class="language-plaintext highlighter-rouge">Application.Current</code> 是否可能为 <code class="language-plaintext highlighter-rouge">null</code> 的分析，由于比较长，请参见我的另一篇博客：</p><ul><li><a href="/post/application-current-may-be-null">WPF 的 Application.Current.Dispatcher 中，Current 可能为 null</a></ul><hr /><p><strong>参考资料</strong></p><ul><li><a href="https://referencesource.microsoft.com/#WindowsBase/Base/System/Windows/Threading/DispatcherObject.cs">DispatcherObject.cs</a></ul><p> 本文会经常更新，请阅读原文： <a href="/post/application-dispatcher-will-never-be-null.html">https://blog.walterlv.com/post/application-dispatcher-will-never-be-null.html</a> ，以避免陈旧错误知识的误导，同时有更好的阅读体验。</p><p> <a rel="知识共享许可协议" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="知识共享许可协议" src="https://blog.walterlv.com/assets/img/by-nc-sa.svg" /> </a></p><p> 本作品采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可。欢迎转载、使用、重新发布，但务必保留文章署名 吕毅 （包含链接： <a href="https://blog.walterlv.com">https://blog.walterlv.com</a> ），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。如有任何疑问，请 <a href="mailto:walter.lv@qq.com">与我联系 (walter.lv@qq.com)</a> 。</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="comments-wrapper"> 登录 GitHub 账号进行评论</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null - walterlv&url=https://blog.walterlv.com/post/application-dispatcher-will-never-be-null.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null - walterlv&u=https://blog.walterlv.com/post/application-dispatcher-will-never-be-null.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=WPF 的 Application.Current.Dispatcher 中，Dispatcher 属性一定不会为 null - walterlv&url=https://blog.walterlv.com/post/application-dispatcher-will-never-be-null.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/post/monitor-foreground-window-on-windows">如何在控制台程序中监听 Windows 前台窗口的变化</a><li><a href="/post/how-to-start-a-process-with-environment-variables-without-code">在 Windows 上如何在启动程序时单独为这个程序指定环境变量，而不需要编写任何代码或脚本</a><li><a href="/post/wpf-draw-a-hsl-hsb-palette-using-hlsl">WPF 像素着色器进阶：使用 HLSL 编写一个高性能的实时变化的 HSL/HSV/HSB 调色盘</a><li><a href="/post/create-wpf-pixel-shader-effects-using-shazzam-shader-editor.html">WPF 像素着色器入门：使用 Shazzam Shader Editor 编写 HLSL 像素着色器代码</a><li><a href="/post/where-is-the-windows-10-native-icons.html">Windows 10 自带那么多图标，去哪里找呢？</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><section class="comments"> <script src="https://utteranc.es/client.js" repo="walterlv/BlogComments" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></section></div></div></div><footer class="d-flex flex-column w-100 justify-content-center"><div id="analytics-box"> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-108101550-1"></script> <script> document.addEventListener("DOMContentLoaded", function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-108101550-1'); }); </script> <script async type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1264408226'%3E%3C/span%3E%3Cscript src='//s22.cnzz.com/z_stat.php%3Fid%3D1264408226%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2014-2024 <a href="https://github.com/walterlv">walterlv</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由吕毅按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，基于 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题修改。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
