<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="支持 Windows 10 最新 PerMonitorV2 特性的 WPF 多屏高 DPI 应用开发" /><meta name="author" content="吕毅" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="Windows 10 自 1703 开始引入第二代的多屏 DPI 机制（PerMonitor V2），而 WPF 框架可以支持此第二代的多屏 DPI 机制。 本文将介绍 WPF 框架利用第二代多屏 DPI 机制进行高 DPI 适配的方法。同时，也介绍低版本的 WPF 或者低版本的操作系统下如何做兼容。" /><meta property="og:description" content="Windows 10 自 1703 开始引入第二代的多屏 DPI 机制（PerMonitor V2），而 WPF 框架可以支持此第二代的多屏 DPI 机制。 本文将介绍 WPF 框架利用第二代多屏 DPI 机制进行高 DPI 适配的方法。同时，也介绍低版本的 WPF 或者低版本的操作系统下如何做兼容。" /><link rel="canonical" href="https://blog.walterlv.com/post/windows-high-dpi-development-for-wpf.html" /><meta property="og:url" content="https://blog.walterlv.com/post/windows-high-dpi-development-for-wpf.html" /><meta property="og:site_name" content="walterlv" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-06-10T16:41:39+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="支持 Windows 10 最新 PerMonitorV2 特性的 WPF 多屏高 DPI 应用开发" /><meta name="twitter:site" content="@_lvyi_" /><meta name="twitter:creator" content="@吕毅" /> <script type="application/ld+json"> {"datePublished":"2020-06-10T16:41:39+08:00","description":"Windows 10 自 1703 开始引入第二代的多屏 DPI 机制（PerMonitor V2），而 WPF 框架可以支持此第二代的多屏 DPI 机制。 本文将介绍 WPF 框架利用第二代多屏 DPI 机制进行高 DPI 适配的方法。同时，也介绍低版本的 WPF 或者低版本的操作系统下如何做兼容。","dateModified":"2021-12-20T00:40:29+08:00","headline":"支持 Windows 10 最新 PerMonitorV2 特性的 WPF 多屏高 DPI 应用开发","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.walterlv.com/post/windows-high-dpi-development-for-wpf.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.walterlv.com/assets/img/logo.png"},"name":"吕毅"},"url":"https://blog.walterlv.com/post/windows-high-dpi-development-for-wpf.html","author":{"@type":"Person","name":"吕毅"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>支持 Windows 10 最新 PerMonitorV2 特性的 WPF 多屏高 DPI 应用开发 - walterlv</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="walterlv"><meta name="application-name" content="walterlv"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="page-bluring-bg" style=" background-image: url('/static/posts/2018-10-18-18-18-31.png'); "></div><div id="topbar-wrapper" class="row topbar-down"><div id="topbar" class="col-12 d-flex h-100 align-items-center"><div id="topbar-logoside" class="col"> <a id="topbar-logo" href="https://blog.walterlv.com" alt="avatar"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <a id="topbar-title" class="site-title" href="https://blog.walterlv.com" alt="walterlv"> walterlv </a></div><div id="topbar-searchside" class="justify-content-center col-5"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div><div class="col"></div></div></div><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="sidebar-box post-item-box profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">吕毅</a></div><div class="site-subtitle font-italic">.NET and Windows App Developer, Microsoft MVP</div></div><ul class="sidebar-box post-item-box"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/friends/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>朋友和收藏</span> </a><li class="nav-item"> <a href="/mind/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>胡思乱想</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/walterlv" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_lvyi_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['walter.lv','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>支持 Windows 10 最新 PerMonitorV2 特性的 WPF 多屏高 DPI 应用开发</h1><div class="post-meta text-muted"><div class="d-flex"> <span> 吕毅 </span> <span> 发表于 <em class="timeago" date="2018-10-22 18:04:01 +0800" data-toggle="tooltip" data-placement="bottom" title="2018-10-22, 18:04 +0800" >2018-10-22</em> </span> <span> 更新于 <em class="timeago" date="2020-06-10 16:41:39 +0800" data-toggle="tooltip" data-placement="bottom" title="2020-06-10, 16:41 +0800" >2020-06-10</em> </span></div></div><div class="post-content"><p>Windows 10 自 1703 开始引入第二代的多屏 DPI 机制（PerMonitor V2），而 WPF 框架可以支持此第二代的多屏 DPI 机制。</p><p>本文将介绍 WPF 框架利用第二代多屏 DPI 机制进行高 DPI 适配的方法。同时，也介绍低版本的 WPF 或者低版本的操作系统下如何做兼容。</p><hr /><div id="toc"></div><h2 id="添加应用程序清单文件">添加应用程序清单文件<a href="#添加应用程序清单文件"><i class="fas fa-hashtag"></i></a></h2></h2><p>在你现有 WPF 项目的主项目中需要添加两个文件以支持第二代的多屏 DPI 机制。</p><ul><li>app.manifest <em>(决定性文件)</em><li>app.config <em>(修复 Bug, .NET Framework 4.6.2 及以上可忽略)</em></ul><p><img data-proofer-ignore data-src="/static/posts/2018-10-18-18-18-31.png" alt="项目中新增的两个文件" /><br /> ▲ 项目中新增的两个文件</p><p>默认情况下，app.config 在你创建 WPF 项目的时候就会存在，而 app.manifest 则不是。如果你的项目中已经存在这两个文件，就不需要添加了。</p><h3 id="如果你没有-appconfig如何添加">如果你没有 app.config，如何添加？<a href="#如果你没有-appconfig如何添加"><i class="fas fa-hashtag"></i></a></h3></h3><p>打开项目属性，然后在属性中选择 .NET Framework 的版本，无论你选择哪个，app.config 都会自动为你添加。</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-19-11-54-14.png" alt="选择 .NET Framework 版本以便添加 app.config 文件" /></p><p>当然，正统的方法是跟下面的 app.manifest 的添加方法相同，你会在下面看到 Visual Studio 新建项中 app.manifest 和 app.config 文件是挨在一起的。</p><h3 id="如果你没有-appmanifest如何添加">如果你没有 app.manifest，如何添加？<a href="#如果你没有-appmanifest如何添加"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-proofer-ignore data-src="/static/posts/2018-10-22-15-56-38.png" alt="新建文件的时候选择应用程序清单文件（应用程序配置文件就在旁边）" /><br /> ▲ 新建文件的时候选择应用程序清单文件（应用程序配置文件就在旁边）</p><h2 id="了解-wpf-清单文件中的-dpi-感知设置">了解 WPF 清单文件中的 DPI 感知设置<a href="#了解-wpf-清单文件中的-dpi-感知设置"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="dpiaware">DpiAware<a href="#dpiaware"><i class="fas fa-hashtag"></i></a></h3></h3><p>在你打开了 app.manifest 文件后，找到以下代码，然后取消注释：</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c">&lt;!-- Indicates that the application is DPI-aware and will not be automatically scaled by Windows at higher
    DPIs. Windows Presentation Foundation (WPF) applications are automatically DPI-aware and do not need 
    to opt in. Windows Forms applications targeting .NET Framework 4.6 that opt into this setting, should 
    also set the 'EnableWindowsFormsHighDpiAutoResizing' setting to 'true' in their app.config. --&gt;</span>
<span class="c">&lt;!--
&lt;application xmlns="urn:schemas-microsoft-com:asm.v3"&gt;
&lt;windowsSettings&gt;
    &lt;dpiAware xmlns="http://schemas.microsoft.com/SMI/2005/WindowsSettings"&gt;true&lt;/dpiAware&gt;
&lt;/windowsSettings&gt;
&lt;/application&gt;
--&gt;</span>
</pre></table></code></div></div><p>上面这一段代码是普通的 DPI 感知的清单设置，开启后获得系统 DPI 感知级别（System DPI Awareness）。</p><p>如果要开启 Per-Monitor DPI 感知，将上面的 <code class="language-plaintext highlighter-rouge">true</code> 改成 <code class="language-plaintext highlighter-rouge">true/pm</code>（pm 表示 per-monitor）。</p><p>不过这只是兼容性的设计而已，感谢老版本的系统使用字符串包含的方式，于是可以老版本的系统可以兼容新的 DPI 感知值：</p><ul><li>什么都不填<ul><li>如果你额外也没做什么 DPI 相关的操作，那么就是 Unaware。<li>如果你在程序启动的时候调用了 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/shellscalingapi/nf-shellscalingapi-setprocessdpiawareness">SetProcessDpiAwareness</a> 或 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-setprocessdpiaware?wt.mc_id=MVP">SetProcessDPIAware</a> 函数，那么就会按照调用此函数的效果来感知 DPI。</ul><li>包含 <code class="language-plaintext highlighter-rouge">true</code> 字符串<ul><li>当前进程设置为系统级 DPI 感知（System DPI Awareness）。</ul><li>包含 <code class="language-plaintext highlighter-rouge">false</code> 字符串<ul><li>在 Windows Vista / 7 / 8 中，与什么都不填的效果是一样的。<li>在 Windows 8.1 / 10 中，当前进程设置为不感知 DPI（Unaware），就算你调用了 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/shellscalingapi/nf-shellscalingapi-setprocessdpiawareness">SetProcessDpiAwareness</a> 和 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-setprocessdpiaware?wt.mc_id=MVP">SetProcessDPIAware</a> 也是没有用的。</ul><li>包含 <code class="language-plaintext highlighter-rouge">true/pm</code> 字符串<ul><li>在 Windows Vista / 7 / 8 中，当前进程设置为系统级 DPI 感知（System DPI Awareness）。<li>在 Windows 8.1 / 10 中，当前进程设置为屏幕级 DPI 感知（Per-Monitor DPI Awareness）。</ul><li>包含 <code class="language-plaintext highlighter-rouge">per monitor</code> 字符串<ul><li>在 Windows Vista / 7 / 8 中，与什么都不填的效果是一样的。<li>在 Windows 8.1 / 10 中，当前进程设置为屏幕级 DPI 感知（Per-Monitor DPI Awareness）。</ul><li>其他任何字符串<ul><li>在 Windows Vista / 7 / 8 中，与什么都不填的效果是一样的。<li>在 Windows 8.1 / 10 中，当前进程设置为不感知 DPI（Unaware），就算你调用了 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/shellscalingapi/nf-shellscalingapi-setprocessdpiawareness">SetProcessDpiAwareness</a> 和 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-setprocessdpiaware?wt.mc_id=MVP">SetProcessDPIAware</a> 也是没有用的。</ul></ul><p>说明一下，<a href="https://docs.microsoft.com/en-us/windows/desktop/api/shellscalingapi/nf-shellscalingapi-setprocessdpiawareness">SetProcessDpiAwareness</a> 是新 API，要求的最低系统版本是 Windows 8.1，调用这个才能指定为 Per-Monitor 的 DPI 感知。而 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-setprocessdpiaware?wt.mc_id=MVP">SetProcessDPIAware</a> 是 Vista 开始引入的老 API，没有参数可以传。</p><h3 id="dpiawareness">DpiAwareness<a href="#dpiawareness"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-xml highlighter-rouge"><div class="code-header"> <span label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nt">&lt;asmv3:application&gt;</span>
  <span class="nt">&lt;asmv3:windowsSettings</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/SMI/2016/WindowsSettings"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dpiAwareness&gt;</span>PerMonitorV2, unaware<span class="nt">&lt;/dpiAwareness&gt;</span>
  <span class="nt">&lt;/asmv3:windowsSettings&gt;</span>
<span class="nt">&lt;/asmv3:application&gt;</span>
</pre></table></code></div></div><p>注意：<strong>只有 Windows 10 (1607) 及以上版本才会识别此节点的 DPI 设置</strong>。如果你设置了 <code class="language-plaintext highlighter-rouge">dpiAwareness</code> 节点，那么 <code class="language-plaintext highlighter-rouge">dpiAware</code> 就会被忽略。</p><p>建议你可以两个节点都指定，这样既可以使用到 Windows 10 1607 的新特性，又可以兼容老版本的 Windows 操作系统。</p><p><code class="language-plaintext highlighter-rouge">dpiAwareness</code> 节点支持设置一个或多个 DPI 感知级别，用逗号分隔。如果你指定了多个，那么操作系统会从第一个开始识别，如果能识别就使用，否则会找第二个。用这种方式，未来的应用可以指定当前系统不支持的 DPI 感知级别。</p><p>鉴于此，在目前 Windows 7 还大行其道的今天，为了兼容，<code class="language-plaintext highlighter-rouge">dpiAwareness</code> 和 <code class="language-plaintext highlighter-rouge">dpiAware</code> 都设置是比较靠谱的。</p><p><code class="language-plaintext highlighter-rouge">dpiAwareness</code> 节点目前支持的值有：</p><ul><li>什么都不设置<ul><li>按 <code class="language-plaintext highlighter-rouge">dpiAware</code> 节点的结果来</ul><li>整个逗号分隔的序列都没有能识别的 DPI 感知级别<ul><li>如果你额外也没做什么 DPI 相关的操作，那么就是 Unaware。<li>如果你在程序启动的时候调用了 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/shellscalingapi/nf-shellscalingapi-setprocessdpiawareness">SetProcessDpiAwareness</a> 或 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-setprocessdpiaware?wt.mc_id=MVP">SetProcessDPIAware</a> 函数，那么就会按照调用此函数的效果来感知 DPI。</ul><li>第一个能识别的感知级别是 <code class="language-plaintext highlighter-rouge">system</code><ul><li>当前进程设置为系统级 DPI 感知（System DPI Awareness）。</ul><li>第一个能识别的感知级别是 <code class="language-plaintext highlighter-rouge">permonitor</code><ul><li>当前进程设置为屏幕级 DPI 感知（Per-Monitor DPI Awareness）。</ul><li>第一个能识别的感知级别是 <code class="language-plaintext highlighter-rouge">permonitorv2</code><ul><li>当前进程设置为第二代屏幕级 DPI 感知（Per-Monitor V2 DPI Awareness）。<li>仅在 Windows 10 (1703) 及以上版本才可被识别</ul><li>第一个能识别的感知级别是 <code class="language-plaintext highlighter-rouge">unaware</code><ul><li>当前进程设置为不感知 DPI（Unaware），就算你调用了 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/shellscalingapi/nf-shellscalingapi-setprocessdpiawareness">SetProcessDpiAwareness</a> 和 <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winuser/nf-winuser-setprocessdpiaware?wt.mc_id=MVP">SetProcessDPIAware</a> 也是没有用的。</ul></ul><h2 id="使-wpf-程序支持-per-monitor-v2-级-dpi-感知">使 WPF 程序支持 Per-Monitor V2 级 DPI 感知<a href="#使-wpf-程序支持-per-monitor-v2-级-dpi-感知"><i class="fas fa-hashtag"></i></a></h2></h2><p>前面我们分析 App.Manifest 文件中 DPI 的设置后，几乎得到一个信息，<code class="language-plaintext highlighter-rouge">dpiAware</code> 和 <code class="language-plaintext highlighter-rouge">dpiAwareness</code> 都是要设置的，除非以后绝大多数用户的系统版本都到达 Windows 10 (1607) 及以上。</p><p>以下是推荐的 DPI 感知级别设置：</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nt">&lt;application</span> <span class="na">xmlns=</span><span class="s">"urn:schemas-microsoft-com:asm.v3"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;windowsSettings&gt;</span>
    <span class="c">&lt;!-- The combination of below two tags have the following effect : 
         1. Per-Monitor for &gt;= Windows 10 Anniversary Update
         2. System &lt; Windows 10 Anniversary Update --&gt;</span>
    <span class="nt">&lt;dpiAwareness</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/SMI/2016/WindowsSettings"</span><span class="nt">&gt;</span>PerMonitorV2<span class="nt">&lt;/dpiAwareness&gt;</span>
    <span class="nt">&lt;dpiAware</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/SMI/2005/WindowsSettings"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/dpiAware&gt;</span>
  <span class="nt">&lt;/windowsSettings&gt;</span>
<span class="nt">&lt;/application&gt;</span>
</pre></table></code></div></div><p>需要注意：系统版本在 Windows 10 (1703) 或以上，V2 的感知级别才会生效，否则就直接使用系统级 DPI 感知。</p><p>这里我们其实偷懒了，这种写法方便我们仅处理两种不同的 DPI 缩放规则：</p><ol><li>Windows 10 (1703) 之后的系统，全按最全支持来做兼容；<li>其他系统，全按 Windows 7 的支持级别来做兼容。</ol><p>你可能注意到本文文末的参考文章中有微软的官方博客，里面推荐的是支持所有级别的 DPI 感知。这看你的需求，因为部分 DPI 相关的模块如果你打算都支持，可能需要更加复杂的判定和计算。本文推荐的少一些，省一点开发量（反正 Windows 8.1 和 Windows 10 早期版本的用户量太少，这部分用户体验不比 Windows 7 差，又不是不能用）。</p><p><img data-proofer-ignore data-src="/static/posts/2020-06-10-16-41-32.png" alt="又不是不能用" /></p><p>第一代和第二代的 Per-Monitor 感知之间的差异，可以参考：<a href="/post/windows-high-dpi-development">Windows 下的高 DPI 应用开发（UWP / WPF / Windows Forms / Win32） - walterlv</a></p><p>额外的，如果你的 .NET Framework 版本在 .NET Framework 4.6.2 以下，但操作系统在 Windows 10 及以上，你还需要修改 App.config 文件（在 <code class="language-plaintext highlighter-rouge">&lt;configuration /&gt;</code> 节点）。</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nt">&lt;runtime&gt;</span>
  <span class="nt">&lt;AppContextSwitchOverrides</span> <span class="na">value =</span> <span class="s">"Switch.System.Windows.DoNotScaleForDpiChanges=false"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/runtime&gt;</span>
</pre></table></code></div></div><p>注意：</p><ol><li>这个值要设为 <code class="language-plaintext highlighter-rouge">false</code>。（微软官方吐槽：Yes, set it to false. Double negative FTW!）<li><code class="language-plaintext highlighter-rouge">AppContextSwitchOverrides</code> 不能被设置两次，如果一已经设置了其他值，需要用分号分隔多个值。</ol><p>特别说明，当面向 .NET Framework 4.6.2 以下版本编译，但运行于 Windows 10 (1607) 和以上版本时，只需要添加 <code class="language-plaintext highlighter-rouge">Switch.System.Windows.DoNotScaleForDpiChanges=false</code> 即可让 WPF 程序处理 Dpi Change 消息，此时 WPF 程序就像高版本的 .NET Framework 中一样能够正常处理多屏下的 DPI 缩放。</p><p>以上，划重点 <strong>你并不需要编译为高版本的 .NET Framework 即可获得 Per-Monitor 的 DPI 缩放支持</strong>。</p><h2 id="wpf-程序在特殊清单设置下的效果">WPF 程序在特殊清单设置下的效果<a href="#wpf-程序在特殊清单设置下的效果"><i class="fas fa-hashtag"></i></a></h2></h2><p><code class="language-plaintext highlighter-rouge">dpiAwareness</code> 不设置，<code class="language-plaintext highlighter-rouge">dpiAware</code> 节点设置为 <code class="language-plaintext highlighter-rouge">true/pm</code>：</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-22-17-28-31.png" alt="100% DPI" /><br /> ▲ 100% DPI</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-22-17-28-52.png" alt="150% DPI" /><br /> ▲ 150% DPI</p><p>注意到标题栏（非客户区）没有缩放，而 WPF 区域（客户区）清晰地缩放了。</p><p><code class="language-plaintext highlighter-rouge">dpiAwareness</code> 不设置，<code class="language-plaintext highlighter-rouge">dpiAware</code> 节点设置为 <code class="language-plaintext highlighter-rouge">true</code>：</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-22-17-28-31.png" alt="100% DPI" /><br /> ▲ 100% DPI</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-22-17-30-59.png" alt="150% DPI" /><br /> ▲ 150% DPI</p><p>注意到标题栏（非客户区）被缩放了，而 WPF 区域（客户区）被 DPI 虚拟化进行了位图拉伸（模糊）。</p><p><code class="language-plaintext highlighter-rouge">dpiAwareness</code> 不设置，<code class="language-plaintext highlighter-rouge">dpiAware</code> 节点设置为 <code class="language-plaintext highlighter-rouge">true/pm12345</code>：</p><p>此时，WPF 程序无法启动！！！而你只需要减少一位数字，例如写成 <code class="language-plaintext highlighter-rouge">true/pm1234</code> 即可成功启动，效果跟 <code class="language-plaintext highlighter-rouge">true</code> 是一样的，注意效果 <strong>不是</strong> <code class="language-plaintext highlighter-rouge">true/pm</code>。也就是说，<code class="language-plaintext highlighter-rouge">/pm</code> 并没有显示出它的含义来。额外的，如果设为 <code class="language-plaintext highlighter-rouge">false</code> 但后面跟随那么长的字符串，WPF 程序是可以启动的。</p><p><code class="language-plaintext highlighter-rouge">dpiAwareness</code> 设置为 <code class="language-plaintext highlighter-rouge">PerMonitorV2</code>：</p><p><img data-proofer-ignore data-src="/static/posts/2018-10-22-17-37-33.png" alt="150% DPI" /><br /> ▲ 150% DPI</p><p>注意到标题栏（非客户区）被缩放了，而 WPF 区域（客户区）也能清晰地缩放（仅 Windows 10 1703 及以上系统才是这个效果）。</p><h2 id="低版本-net-framework-和-低版本-windows-下的-wpf-dpi-缩放">低版本 .NET Framework 和 低版本 Windows 下的 WPF DPI 缩放<a href="#低版本-net-framework-和-低版本-windows-下的-wpf-dpi-缩放"><i class="fas fa-hashtag"></i></a></h2></h2><p>由于 Windows 8.1 操作系统用户存量不多，主要是 Windows 7 和 Windows 10。所以我们要么兼容完全不支持 Per-Monitor 的 Windows 7，要么使用具有新特性的 Windows 10 即可获得最佳的开发成本平衡。<strong>使用以上的 DPI 缩放方法足以让你的 WPF 应用在任何一个 .NET Framework 版本下获得针对屏幕的 DPI 清晰缩放（Per-Monitor DPI Awareness）。</strong></p><p>所以仅针对 Windows 8.1 做特殊的 DPI 缩放是不值得的，把 Windows 8.1 当做 Windows 7 来做那种不支持 Per-Monitor 的处理就好了。当然你硬要支持也有相关文档可以看：<a href="https://docs.microsoft.com/en-us/windows/desktop/hidpi/declaring-managed-apps-dpi-aware">Developing a Per-Monitor DPI-Aware WPF Application - Microsoft Docs</a> 了解实现方法。具体是使用 <code class="language-plaintext highlighter-rouge">DisableDpiAwareness</code> 特性和 <a href="https://code.msdn.microsoft.com/windowsdesktop/Per-Monitor-Aware-WPF-e43cde33?wt.mc_id=MVP">Windows Per-Monitor Aware WPF Sample</a> 中的源码。</p><hr /><p><strong>参考资料</strong></p><ul><li><a href="https://docs.microsoft.com/en-us/windows/desktop/hidpi/declaring-managed-apps-dpi-aware?wt.mc_id=MVP">Developing a Per-Monitor DPI-Aware WPF Application - Microsoft Docs</a><li><a href="https://github.com/Microsoft/WPF-Samples/blob/master/PerMonitorDPI/Developer%20Guide%20-%20Per%20Monitor%20DPI%20-%20WPF%20Preview.docx">WPF-Samples/Developer Guide - Per Monitor DPI - WPF Preview.docx at master · Microsoft/WPF-Samples</a><li><a href="https://docs.microsoft.com/en-us/windows/desktop/sbscs/application-manifests?wt.mc_id=MVP">Application Manifests - Microsoft Docs</a><li><a href="https://blogs.windows.com/windowsdeveloper/2017/04/04/high-dpi-scaling-improvements-desktop-applications-windows-10-creators-update/">High-DPI Scaling Improvements for Desktop Applications in the Windows 10 Creators Update (1703) - Windows Developer Blog</a></ul><p> 本文会经常更新，请阅读原文： <a href="/post/windows-high-dpi-development-for-wpf.html">https://blog.walterlv.com/post/windows-high-dpi-development-for-wpf.html</a> ，以避免陈旧错误知识的误导，同时有更好的阅读体验。</p><p> <a rel="知识共享许可协议" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="知识共享许可协议" src="https://blog.walterlv.com/assets/img/by-nc-sa.svg" /> </a></p><p> 本作品采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可。欢迎转载、使用、重新发布，但务必保留文章署名 吕毅 （包含链接： <a href="https://blog.walterlv.com">https://blog.walterlv.com</a> ），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。如有任何疑问，请 <a href="mailto:walter.lv@qq.com">与我联系 (walter.lv@qq.com)</a> 。</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="comments-wrapper"> 登录 GitHub 账号进行评论</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=支持 Windows 10 最新 PerMonitorV2 特性的 WPF 多屏高 DPI 应用开发 - walterlv&url=https://blog.walterlv.com/post/windows-high-dpi-development-for-wpf.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=支持 Windows 10 最新 PerMonitorV2 特性的 WPF 多屏高 DPI 应用开发 - walterlv&u=https://blog.walterlv.com/post/windows-high-dpi-development-for-wpf.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=支持 Windows 10 最新 PerMonitorV2 特性的 WPF 多屏高 DPI 应用开发 - walterlv&url=https://blog.walterlv.com/post/windows-high-dpi-development-for-wpf.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/post/monitor-foreground-window-on-windows">如何在控制台程序中监听 Windows 前台窗口的变化</a><li><a href="/post/how-to-start-a-process-with-environment-variables-without-code">在 Windows 上如何在启动程序时单独为这个程序指定环境变量，而不需要编写任何代码或脚本</a><li><a href="/post/wpf-draw-a-hsl-hsb-palette-using-hlsl">WPF 像素着色器进阶：使用 HLSL 编写一个高性能的实时变化的 HSL/HSV/HSB 调色盘</a><li><a href="/post/create-wpf-pixel-shader-effects-using-shazzam-shader-editor.html">WPF 像素着色器入门：使用 Shazzam Shader Editor 编写 HLSL 像素着色器代码</a><li><a href="/post/where-is-the-windows-10-native-icons.html">Windows 10 自带那么多图标，去哪里找呢？</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><section class="comments"> <script src="https://utteranc.es/client.js" repo="walterlv/BlogComments" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></section></div></div></div><footer class="d-flex flex-column w-100 justify-content-center"><div id="analytics-box"> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-108101550-1"></script> <script> document.addEventListener("DOMContentLoaded", function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-108101550-1'); }); </script> <script async type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1264408226'%3E%3C/span%3E%3Cscript src='//s22.cnzz.com/z_stat.php%3Fid%3D1264408226%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2014-2024 <a href="https://github.com/walterlv">walterlv</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由吕毅按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，基于 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题修改。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
