<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="天前"><meta name="hour-prompt" content="小时前"><meta name="minute-prompt" content="分钟前"><meta name="justnow-prompt" content="刚刚"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="实现一个 WPF 版本的 ConnectedAnimation" /><meta name="author" content="吕毅" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="Windows 10 的创造者更新为开发者们带来了 Connected Animation 连接动画，这也是 Fluent Design System 的一部分。它的视觉引导性很强，用户能够在它的帮助下迅速定位操作的对象。 不过，这是 UWP，而且还是 Windows 10 Creator’s Update 中才带来的特性，WPF 当然没有。于是，我自己写了一个“简易版本”。" /><meta property="og:description" content="Windows 10 的创造者更新为开发者们带来了 Connected Animation 连接动画，这也是 Fluent Design System 的一部分。它的视觉引导性很强，用户能够在它的帮助下迅速定位操作的对象。 不过，这是 UWP，而且还是 Windows 10 Creator’s Update 中才带来的特性，WPF 当然没有。于是，我自己写了一个“简易版本”。" /><link rel="canonical" href="https://blog.walterlv.com/post/connected-animation-of-wpf.html" /><meta property="og:url" content="https://blog.walterlv.com/post/connected-animation-of-wpf.html" /><meta property="og:site_name" content="walterlv" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-12-14T09:54:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="实现一个 WPF 版本的 ConnectedAnimation" /><meta name="twitter:site" content="@_lvyi_" /><meta name="twitter:creator" content="@吕毅" /> <script type="application/ld+json"> {"datePublished":"2018-12-14T09:54:00+08:00","description":"Windows 10 的创造者更新为开发者们带来了 Connected Animation 连接动画，这也是 Fluent Design System 的一部分。它的视觉引导性很强，用户能够在它的帮助下迅速定位操作的对象。 不过，这是 UWP，而且还是 Windows 10 Creator’s Update 中才带来的特性，WPF 当然没有。于是，我自己写了一个“简易版本”。","dateModified":"2021-12-20T00:40:29+08:00","headline":"实现一个 WPF 版本的 ConnectedAnimation","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.walterlv.com/post/connected-animation-of-wpf.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.walterlv.com/assets/img/logo.png"},"name":"吕毅"},"url":"https://blog.walterlv.com/post/connected-animation-of-wpf.html","author":{"@type":"Person","name":"吕毅"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>实现一个 WPF 版本的 ConnectedAnimation - walterlv</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="walterlv"><meta name="application-name" content="walterlv"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="topbar-wrapper" class="row topbar-down"><div id="topbar" class="col-12 d-flex h-100 align-items-center"><div id="topbar-logoside" class="col"> <a id="topbar-logo" href="https://blog.walterlv.com" alt="avatar"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <a id="topbar-title" class="site-title" href="https://blog.walterlv.com" alt="walterlv"> walterlv </a></div><div id="topbar-searchside" class="justify-content-center col-5"> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >取消</span></div><div class="col"></div></div></div><div id="sidebar" class="d-flex flex-column align-items-end" lang="zh-CN"><div class="sidebar-box post-item-box profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">吕毅</a></div><div class="site-subtitle font-italic">.NET and Windows App Developer, Microsoft MVP</div></div><ul class="sidebar-box post-item-box"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/friends/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>朋友和收藏</span> </a><li class="nav-item"> <a href="/mind/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>胡思乱想</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/walterlv" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_lvyi_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['walter.lv','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>实现一个 WPF 版本的 ConnectedAnimation</h1><div class="post-meta text-muted"><div class="d-flex"> <span> 吕毅 </span> <span> 发表于 <em class="timeago" date="2017-12-25 19:44:21 +0800" data-toggle="tooltip" data-placement="bottom" title="2017-12-25, 19:44 +0800" >2017-12-25</em> </span> <span> 更新于 <em class="timeago" date="2018-12-14 09:54:00 +0800" data-toggle="tooltip" data-placement="bottom" title="2018-12-14, 09:54 +0800" >2018-12-14</em> </span></div></div><div class="post-content"><p>Windows 10 的创造者更新为开发者们带来了 Connected Animation 连接动画，这也是 Fluent Design System 的一部分。它的视觉引导性很强，用户能够在它的帮助下迅速定位操作的对象。</p><p>不过，这是 UWP，而且还是 Windows 10 Creator’s Update 中才带来的特性，WPF 当然没有。于是，我自己写了一个“简易版本”。</p><hr /><p><img data-proofer-ignore data-src="https://docs.microsoft.com/en-us/windows/uwp/design/motion/images/connected-animations/example.gif?wt.mc_id=MVP" alt="Connected Animation" /><br /> ▲ Connected Animation 连接动画</p><p id="toc"></p><h2 id="模拟-uwp-中的-api">模拟 UWP 中的 API<a href="#模拟-uwp-中的-api"><i class="fas fa-hashtag"></i></a></h2></h2><p>UWP 中的连接动画能跑起来的最简单代码包含下面两个部分。</p><p>准备动画 <code class="language-plaintext highlighter-rouge">PrepareToAnimate()</code>：</p><blockquote><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ConnectedAnimationService</span><span class="p">.</span><span class="nf">GetForCurrentView</span><span class="p">().</span><span class="nf">PrepareToAnimate</span><span class="p">(</span><span class="cm">/*string */</span><span class="n">key</span><span class="p">,</span> <span class="cm">/*UIElement */</span><span class="n">source</span><span class="p">);</span>
</pre></table></code></div></div></blockquote><p>开始动画 <code class="language-plaintext highlighter-rouge">TryStart</code>：</p><blockquote><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">var</span> <span class="n">animation</span> <span class="p">=</span> <span class="n">ConnectedAnimationService</span><span class="p">.</span><span class="nf">GetForCurrentView</span><span class="p">().</span><span class="nf">GetAnimation</span><span class="p">(</span><span class="cm">/*string */</span><span class="n">key</span><span class="p">);</span>
<span class="n">animation</span><span class="p">?.</span><span class="nf">TryStart</span><span class="p">(</span><span class="cm">/*UIElement */</span><span class="n">destination</span><span class="p">);</span>
</pre></table></code></div></div></blockquote><p>于是，我们至少需要实现这些 API：</p><ul><li><code class="language-plaintext highlighter-rouge">ConnectedAnimationService.GetForCurrentView();</code><li><code class="language-plaintext highlighter-rouge">ConnectedAnimationService.PrepareToAnimate(string key, UIElement source);</code><li><code class="language-plaintext highlighter-rouge">ConnectedAnimationService.GetAnimation(string key);</code><li><code class="language-plaintext highlighter-rouge">ConnectedAnimation.TryStart(UIElement destination);</code></ul><h2 id="实现这个-api">实现这个 API<a href="#实现这个-api"><i class="fas fa-hashtag"></i></a></h2></h2><p>现在，我们需要写两个类才能实现上面那些方法：</p><ul><li><code class="language-plaintext highlighter-rouge">ConnectedAnimationService</code> - 用来管理一个窗口内的所有连接动画<li><code class="language-plaintext highlighter-rouge">ConnectedAnimation</code> - 用来管理和播放一个指定 Key 的连接动画</ul><h3 id="connectedanimationservice">ConnectedAnimationService<a href="#connectedanimationservice"><i class="fas fa-hashtag"></i></a></h3></h3><p>我选用窗口作为一个 <code class="language-plaintext highlighter-rouge">ConnectedAnimationService</code> 的管理单元是因为我可以在一个窗口内实现这样的动画，而跨窗口的动画就非常麻烦了。所以，我试用附加属性为 <code class="language-plaintext highlighter-rouge">Window</code> 附加一个 <code class="language-plaintext highlighter-rouge">ConnectedAnimationService</code> 属性，用于在任何一个 <code class="language-plaintext highlighter-rouge">View</code> 所在的地方获取 <code class="language-plaintext highlighter-rouge">ConnectedAnimationService</code> 的实例。</p><p>每次 <code class="language-plaintext highlighter-rouge">PrepareToAnimate</code> 时我创建一个 <code class="language-plaintext highlighter-rouge">ConnectedAnimation</code> 实例来管理此次的连接动画。为了方便此后根据 Key 查找 <code class="language-plaintext highlighter-rouge">ConnectedAnimation</code> 的实例，我使用字典存储这些实例。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows.Media</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Walterlv.Annotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Walterlv.Demo.Media.Animation</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ConnectedAnimationService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="nf">ConnectedAnimationService</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">ConnectedAnimation</span><span class="p">&gt;</span> <span class="n">_connectingAnimations</span> <span class="p">=</span>
            <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">ConnectedAnimation</span><span class="p">&gt;();</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">PrepareToAnimate</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="kt">string</span> <span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">UIElement</span> <span class="n">source</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">_connectingAnimations</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">info</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"指定的 key 已经做好动画准备，不应该重复进行准备。"</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="n">info</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConnectedAnimation</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">OnAnimationCompleted</span><span class="p">);</span>
            <span class="n">_connectingAnimations</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">OnAnimationCompleted</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="p">((</span><span class="n">ConnectedAnimation</span><span class="p">)</span> <span class="n">sender</span><span class="p">).</span><span class="n">Key</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_connectingAnimations</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">_connectingAnimations</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span>
        <span class="k">public</span> <span class="n">ConnectedAnimation</span> <span class="nf">GetAnimation</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_connectingAnimations</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">info</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">info</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyProperty</span> <span class="n">AnimationServiceProperty</span> <span class="p">=</span>
            <span class="n">DependencyProperty</span><span class="p">.</span><span class="nf">RegisterAttached</span><span class="p">(</span><span class="s">"AnimationService"</span><span class="p">,</span>
                <span class="k">typeof</span><span class="p">(</span><span class="n">ConnectedAnimationService</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ConnectedAnimationService</span><span class="p">),</span>
                <span class="k">new</span> <span class="nf">PropertyMetadata</span><span class="p">(</span><span class="k">default</span><span class="p">(</span><span class="n">ConnectedAnimationService</span><span class="p">)));</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">ConnectedAnimationService</span> <span class="nf">GetForCurrentView</span><span class="p">(</span><span class="n">Visual</span> <span class="n">visual</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">window</span> <span class="p">=</span> <span class="n">Window</span><span class="p">.</span><span class="nf">GetWindow</span><span class="p">(</span><span class="n">visual</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">window</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"此 Visual 未连接到可见的视觉树中。"</span><span class="p">,</span> <span class="k">nameof</span><span class="p">(</span><span class="n">visual</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">service</span> <span class="p">=</span> <span class="p">(</span><span class="n">ConnectedAnimationService</span><span class="p">)</span> <span class="n">window</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="n">AnimationServiceProperty</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">service</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConnectedAnimationService</span><span class="p">();</span>
                <span class="n">window</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="n">AnimationServiceProperty</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">service</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="connectedanimation">ConnectedAnimation<a href="#connectedanimation"><i class="fas fa-hashtag"></i></a></h3></h3><p>这是连接动画的关键实现。</p><p>我创建了一个内部类 <code class="language-plaintext highlighter-rouge">ConnectedAnimationAdorner</code> 用于在 <code class="language-plaintext highlighter-rouge">AdornerLayer</code> 上承载连接动画。<code class="language-plaintext highlighter-rouge">AdornerLayer</code> 是 WPF 中的概念，用于在其他控件上叠加显示一些 UI，UWP 中没有这样的特性。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">class</span> <span class="nc">ConnectedAnimationAdorner</span> <span class="p">:</span> <span class="n">Adorner</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nf">ConnectedAnimationAdorner</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">UIElement</span> <span class="n">adornedElement</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">adornedElement</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Children</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">VisualCollection</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="n">IsHitTestVisible</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="n">VisualCollection</span> <span class="n">Children</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="kt">int</span> <span class="n">VisualChildrenCount</span> <span class="p">=&gt;</span> <span class="n">Children</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="n">Visual</span> <span class="nf">GetVisualChild</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Children</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="n">Size</span> <span class="nf">ArrangeOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">finalSize</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">child</span> <span class="k">in</span> <span class="n">Children</span><span class="p">.</span><span class="n">OfType</span><span class="p">&lt;</span><span class="n">UIElement</span><span class="p">&gt;())</span>
        <span class="p">{</span>
            <span class="n">child</span><span class="p">.</span><span class="nf">Arrange</span><span class="p">(</span><span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">DesiredSize</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">finalSize</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">static</span> <span class="n">ConnectedAnimationAdorner</span> <span class="nf">FindFrom</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">Visual</span> <span class="n">visual</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Window</span><span class="p">.</span><span class="nf">GetWindow</span><span class="p">(</span><span class="n">visual</span><span class="p">)?.</span><span class="n">Content</span> <span class="k">is</span> <span class="n">UIElement</span> <span class="n">root</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">layer</span> <span class="p">=</span> <span class="n">AdornerLayer</span><span class="p">.</span><span class="nf">GetAdornerLayer</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">adorner</span> <span class="p">=</span> <span class="n">layer</span><span class="p">.</span><span class="nf">GetAdorners</span><span class="p">(</span><span class="n">root</span><span class="p">)?.</span><span class="n">OfType</span><span class="p">&lt;</span><span class="n">ConnectedAnimationAdorner</span><span class="p">&gt;().</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">adorner</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">adorner</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConnectedAnimationAdorner</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
                    <span class="n">layer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">adorner</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">adorner</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"指定的 Visual 尚未连接到可见的视觉树中，找不到用于承载动画的容器。"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ClearFor</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">Visual</span> <span class="n">visual</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Window</span><span class="p">.</span><span class="nf">GetWindow</span><span class="p">(</span><span class="n">visual</span><span class="p">)?.</span><span class="n">Content</span> <span class="k">is</span> <span class="n">UIElement</span> <span class="n">root</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">layer</span> <span class="p">=</span> <span class="n">AdornerLayer</span><span class="p">.</span><span class="nf">GetAdornerLayer</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">adorner</span> <span class="p">=</span> <span class="n">layer</span><span class="p">?.</span><span class="nf">GetAdorners</span><span class="p">(</span><span class="n">root</span><span class="p">)?.</span><span class="n">OfType</span><span class="p">&lt;</span><span class="n">ConnectedAnimationAdorner</span><span class="p">&gt;().</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">adorner</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">layer</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">adorner</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>而 <code class="language-plaintext highlighter-rouge">ConnectedAnimationAdorner</code> 的作用是显示一个 <code class="language-plaintext highlighter-rouge">ConnectedVisual</code>。<code class="language-plaintext highlighter-rouge">ConnectedVisual</code> 包含一个源和一个目标，根据 <code class="language-plaintext highlighter-rouge">Progress</code>（进度）属性决定应该分别将源和目标显示到哪个位置，其不透明度分别是多少。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">class</span> <span class="nc">ConnectedVisual</span> <span class="p">:</span> <span class="n">DrawingVisual</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyProperty</span> <span class="n">ProgressProperty</span> <span class="p">=</span> <span class="n">DependencyProperty</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
        <span class="s">"Progress"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ConnectedVisual</span><span class="p">),</span>
        <span class="k">new</span> <span class="nf">PropertyMetadata</span><span class="p">(</span><span class="m">0.0</span><span class="p">,</span> <span class="n">OnProgressChanged</span><span class="p">),</span> <span class="n">ValidateProgress</span><span class="p">);</span>

    <span class="k">public</span> <span class="kt">double</span> <span class="n">Progress</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="nf">GetValue</span><span class="p">(</span><span class="n">ProgressProperty</span><span class="p">);</span>
        <span class="k">set</span> <span class="p">=&gt;</span> <span class="nf">SetValue</span><span class="p">(</span><span class="n">ProgressProperty</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">ValidateProgress</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="k">value</span> <span class="k">is</span> <span class="kt">double</span> <span class="n">progress</span> <span class="p">&amp;&amp;</span> <span class="n">progress</span> <span class="p">&gt;=</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">progress</span> <span class="p">&lt;=</span> <span class="m">1</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OnProgressChanged</span><span class="p">(</span><span class="n">DependencyObject</span> <span class="n">d</span><span class="p">,</span> <span class="n">DependencyPropertyChangedEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">((</span><span class="n">ConnectedVisual</span><span class="p">)</span> <span class="n">d</span><span class="p">).</span><span class="nf">Render</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">e</span><span class="p">.</span><span class="n">NewValue</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="nf">ConnectedVisual</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">Visual</span> <span class="n">source</span><span class="p">,</span> <span class="p">[</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">Visual</span> <span class="n">destination</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_source</span> <span class="p">=</span> <span class="n">source</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
        <span class="n">_destination</span> <span class="p">=</span> <span class="n">destination</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">destination</span><span class="p">));</span>

        <span class="n">_sourceBrush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">VisualBrush</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span><span class="n">Stretch</span> <span class="p">=</span> <span class="n">Stretch</span><span class="p">.</span><span class="n">Fill</span><span class="p">};</span>
        <span class="n">_destinationBrush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">VisualBrush</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span> <span class="p">{</span><span class="n">Stretch</span> <span class="p">=</span> <span class="n">Stretch</span><span class="p">.</span><span class="n">Fill</span><span class="p">};</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Visual</span> <span class="n">_source</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Visual</span> <span class="n">_destination</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Brush</span> <span class="n">_sourceBrush</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Brush</span> <span class="n">_destinationBrush</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Rect</span> <span class="n">_sourceBounds</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">Rect</span> <span class="n">_destinationBounds</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnVisualParentChanged</span><span class="p">(</span><span class="n">DependencyObject</span> <span class="n">oldParent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetParent</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">sourceBounds</span> <span class="p">=</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetContentBounds</span><span class="p">(</span><span class="n">_source</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sourceBounds</span><span class="p">.</span><span class="n">IsEmpty</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sourceBounds</span> <span class="p">=</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetDescendantBounds</span><span class="p">(</span><span class="n">_source</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">_sourceBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
            <span class="n">_source</span><span class="p">.</span><span class="nf">PointToScreen</span><span class="p">(</span><span class="n">sourceBounds</span><span class="p">.</span><span class="n">TopLeft</span><span class="p">),</span>
            <span class="n">_source</span><span class="p">.</span><span class="nf">PointToScreen</span><span class="p">(</span><span class="n">sourceBounds</span><span class="p">.</span><span class="n">BottomRight</span><span class="p">));</span>
        <span class="n">_sourceBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
            <span class="nf">PointFromScreen</span><span class="p">(</span><span class="n">_sourceBounds</span><span class="p">.</span><span class="n">TopLeft</span><span class="p">),</span>
            <span class="nf">PointFromScreen</span><span class="p">(</span><span class="n">_sourceBounds</span><span class="p">.</span><span class="n">BottomRight</span><span class="p">));</span>

        <span class="kt">var</span> <span class="n">destinationBounds</span> <span class="p">=</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetContentBounds</span><span class="p">(</span><span class="n">_destination</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">destinationBounds</span><span class="p">.</span><span class="n">IsEmpty</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">destinationBounds</span> <span class="p">=</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetDescendantBounds</span><span class="p">(</span><span class="n">_destination</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">_destinationBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
            <span class="n">_destination</span><span class="p">.</span><span class="nf">PointToScreen</span><span class="p">(</span><span class="n">destinationBounds</span><span class="p">.</span><span class="n">TopLeft</span><span class="p">),</span>
            <span class="n">_destination</span><span class="p">.</span><span class="nf">PointToScreen</span><span class="p">(</span><span class="n">destinationBounds</span><span class="p">.</span><span class="n">BottomRight</span><span class="p">));</span>
        <span class="n">_destinationBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
            <span class="nf">PointFromScreen</span><span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">TopLeft</span><span class="p">),</span>
            <span class="nf">PointFromScreen</span><span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">BottomRight</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Render</span><span class="p">(</span><span class="kt">double</span> <span class="n">progress</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">bounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
            <span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">Left</span> <span class="p">-</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Left</span><span class="p">)</span> <span class="p">*</span> <span class="n">progress</span> <span class="p">+</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Left</span><span class="p">,</span>
            <span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">Top</span> <span class="p">-</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Top</span><span class="p">)</span> <span class="p">*</span> <span class="n">progress</span> <span class="p">+</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Top</span><span class="p">,</span>
            <span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">Width</span> <span class="p">-</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Width</span><span class="p">)</span> <span class="p">*</span> <span class="n">progress</span> <span class="p">+</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span>
            <span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span> <span class="p">*</span> <span class="n">progress</span> <span class="p">+</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span>

        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dc</span> <span class="p">=</span> <span class="nf">RenderOpen</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">dc</span><span class="p">.</span><span class="nf">DrawRectangle</span><span class="p">(</span><span class="n">_sourceBrush</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">bounds</span><span class="p">);</span>
            <span class="n">dc</span><span class="p">.</span><span class="nf">PushOpacity</span><span class="p">(</span><span class="n">progress</span><span class="p">);</span>
            <span class="n">dc</span><span class="p">.</span><span class="nf">DrawRectangle</span><span class="p">(</span><span class="n">_destinationBrush</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">bounds</span><span class="p">);</span>
            <span class="n">dc</span><span class="p">.</span><span class="nf">Pop</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>最后，用一个 <code class="language-plaintext highlighter-rouge">DoubleAnimation</code> 控制 <code class="language-plaintext highlighter-rouge">Progress</code> 属性，来实现连接动画。</p><p>完整的包含内部类的代码如下：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
</pre><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows.Documents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows.Media</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Windows.Media.Animation</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Walterlv.Annotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Walterlv.Demo.Media.Animation</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ConnectedAnimation</span>
    <span class="p">{</span>
        <span class="k">internal</span> <span class="nf">ConnectedAnimation</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="kt">string</span> <span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">UIElement</span> <span class="n">source</span><span class="p">,</span> <span class="p">[</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">EventHandler</span> <span class="n">completed</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Key</span> <span class="p">=</span> <span class="n">key</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
            <span class="n">_source</span> <span class="p">=</span> <span class="n">source</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
            <span class="n">_reportCompleted</span> <span class="p">=</span> <span class="n">completed</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">completed</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Key</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">UIElement</span> <span class="n">_source</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">EventHandler</span> <span class="n">_reportCompleted</span><span class="p">;</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">TryStart</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">UIElement</span> <span class="n">destination</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">TryStart</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="n">UIElement</span><span class="p">&gt;());</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">TryStart</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">UIElement</span> <span class="n">destination</span><span class="p">,</span> <span class="p">[</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">UIElement</span><span class="p">&gt;</span> <span class="n">coordinatedElements</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">destination</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">destination</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">coordinatedElements</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">coordinatedElements</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nf">Equals</span><span class="p">(</span><span class="n">_source</span><span class="p">,</span> <span class="n">destination</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// 正在播动画？动画播完废弃了？false</span>

            <span class="c1">// 准备播放连接动画。</span>
            <span class="kt">var</span> <span class="n">adorner</span> <span class="p">=</span> <span class="n">ConnectedAnimationAdorner</span><span class="p">.</span><span class="nf">FindFrom</span><span class="p">(</span><span class="n">destination</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">connectionHost</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConnectedVisual</span><span class="p">(</span><span class="n">_source</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>
            <span class="n">adorner</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">connectionHost</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">storyboard</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Storyboard</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">animation</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DoubleAnimation</span><span class="p">(</span><span class="m">0.0</span><span class="p">,</span> <span class="m">1.0</span><span class="p">,</span> <span class="k">new</span> <span class="nf">Duration</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">10.6</span><span class="p">)))</span>
            <span class="p">{</span>
                <span class="n">EasingFunction</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CubicEase</span> <span class="p">{</span><span class="n">EasingMode</span> <span class="p">=</span> <span class="n">EasingMode</span><span class="p">.</span><span class="n">EaseInOut</span><span class="p">},</span>
            <span class="p">};</span>
            <span class="n">Storyboard</span><span class="p">.</span><span class="nf">SetTarget</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">connectionHost</span><span class="p">);</span>
            <span class="n">Storyboard</span><span class="p">.</span><span class="nf">SetTargetProperty</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="k">new</span> <span class="nf">PropertyPath</span><span class="p">(</span><span class="n">ConnectedVisual</span><span class="p">.</span><span class="n">ProgressProperty</span><span class="p">.</span><span class="n">Name</span><span class="p">));</span>
            <span class="n">storyboard</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">animation</span><span class="p">);</span>
            <span class="n">storyboard</span><span class="p">.</span><span class="n">Completed</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="nf">_reportCompleted</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">EventArgs</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
                <span class="c1">//destination.ClearValue(UIElement.VisibilityProperty);</span>
                <span class="n">adorner</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">connectionHost</span><span class="p">);</span>
            <span class="p">};</span>
            <span class="c1">//destination.Visibility = Visibility.Hidden;</span>
            <span class="n">storyboard</span><span class="p">.</span><span class="nf">Begin</span><span class="p">();</span>

            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">class</span> <span class="nc">ConnectedVisual</span> <span class="p">:</span> <span class="n">DrawingVisual</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyProperty</span> <span class="n">ProgressProperty</span> <span class="p">=</span> <span class="n">DependencyProperty</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
                <span class="s">"Progress"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ConnectedVisual</span><span class="p">),</span>
                <span class="k">new</span> <span class="nf">PropertyMetadata</span><span class="p">(</span><span class="m">0.0</span><span class="p">,</span> <span class="n">OnProgressChanged</span><span class="p">),</span> <span class="n">ValidateProgress</span><span class="p">);</span>

            <span class="k">public</span> <span class="kt">double</span> <span class="n">Progress</span>
            <span class="p">{</span>
                <span class="k">get</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="nf">GetValue</span><span class="p">(</span><span class="n">ProgressProperty</span><span class="p">);</span>
                <span class="k">set</span> <span class="p">=&gt;</span> <span class="nf">SetValue</span><span class="p">(</span><span class="n">ProgressProperty</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">ValidateProgress</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="k">value</span> <span class="k">is</span> <span class="kt">double</span> <span class="n">progress</span> <span class="p">&amp;&amp;</span> <span class="n">progress</span> <span class="p">&gt;=</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">progress</span> <span class="p">&lt;=</span> <span class="m">1</span><span class="p">;</span>

            <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OnProgressChanged</span><span class="p">(</span><span class="n">DependencyObject</span> <span class="n">d</span><span class="p">,</span> <span class="n">DependencyPropertyChangedEventArgs</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="p">((</span><span class="n">ConnectedVisual</span><span class="p">)</span> <span class="n">d</span><span class="p">).</span><span class="nf">Render</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">e</span><span class="p">.</span><span class="n">NewValue</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="nf">ConnectedVisual</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">Visual</span> <span class="n">source</span><span class="p">,</span> <span class="p">[</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">Visual</span> <span class="n">destination</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_source</span> <span class="p">=</span> <span class="n">source</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
                <span class="n">_destination</span> <span class="p">=</span> <span class="n">destination</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">destination</span><span class="p">));</span>

                <span class="n">_sourceBrush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">VisualBrush</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span><span class="n">Stretch</span> <span class="p">=</span> <span class="n">Stretch</span><span class="p">.</span><span class="n">Fill</span><span class="p">};</span>
                <span class="n">_destinationBrush</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">VisualBrush</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span> <span class="p">{</span><span class="n">Stretch</span> <span class="p">=</span> <span class="n">Stretch</span><span class="p">.</span><span class="n">Fill</span><span class="p">};</span>
            <span class="p">}</span>

            <span class="k">private</span> <span class="k">readonly</span> <span class="n">Visual</span> <span class="n">_source</span><span class="p">;</span>
            <span class="k">private</span> <span class="k">readonly</span> <span class="n">Visual</span> <span class="n">_destination</span><span class="p">;</span>
            <span class="k">private</span> <span class="k">readonly</span> <span class="n">Brush</span> <span class="n">_sourceBrush</span><span class="p">;</span>
            <span class="k">private</span> <span class="k">readonly</span> <span class="n">Brush</span> <span class="n">_destinationBrush</span><span class="p">;</span>
            <span class="k">private</span> <span class="n">Rect</span> <span class="n">_sourceBounds</span><span class="p">;</span>
            <span class="k">private</span> <span class="n">Rect</span> <span class="n">_destinationBounds</span><span class="p">;</span>

            <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnVisualParentChanged</span><span class="p">(</span><span class="n">DependencyObject</span> <span class="n">oldParent</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetParent</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="kt">var</span> <span class="n">sourceBounds</span> <span class="p">=</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetContentBounds</span><span class="p">(</span><span class="n">_source</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sourceBounds</span><span class="p">.</span><span class="n">IsEmpty</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">sourceBounds</span> <span class="p">=</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetDescendantBounds</span><span class="p">(</span><span class="n">_source</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">_sourceBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
                    <span class="n">_source</span><span class="p">.</span><span class="nf">PointToScreen</span><span class="p">(</span><span class="n">sourceBounds</span><span class="p">.</span><span class="n">TopLeft</span><span class="p">),</span>
                    <span class="n">_source</span><span class="p">.</span><span class="nf">PointToScreen</span><span class="p">(</span><span class="n">sourceBounds</span><span class="p">.</span><span class="n">BottomRight</span><span class="p">));</span>
                <span class="n">_sourceBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
                    <span class="nf">PointFromScreen</span><span class="p">(</span><span class="n">_sourceBounds</span><span class="p">.</span><span class="n">TopLeft</span><span class="p">),</span>
                    <span class="nf">PointFromScreen</span><span class="p">(</span><span class="n">_sourceBounds</span><span class="p">.</span><span class="n">BottomRight</span><span class="p">));</span>

                <span class="kt">var</span> <span class="n">destinationBounds</span> <span class="p">=</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetContentBounds</span><span class="p">(</span><span class="n">_destination</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">destinationBounds</span><span class="p">.</span><span class="n">IsEmpty</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">destinationBounds</span> <span class="p">=</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetDescendantBounds</span><span class="p">(</span><span class="n">_destination</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">_destinationBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
                    <span class="n">_destination</span><span class="p">.</span><span class="nf">PointToScreen</span><span class="p">(</span><span class="n">destinationBounds</span><span class="p">.</span><span class="n">TopLeft</span><span class="p">),</span>
                    <span class="n">_destination</span><span class="p">.</span><span class="nf">PointToScreen</span><span class="p">(</span><span class="n">destinationBounds</span><span class="p">.</span><span class="n">BottomRight</span><span class="p">));</span>
                <span class="n">_destinationBounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
                    <span class="nf">PointFromScreen</span><span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">TopLeft</span><span class="p">),</span>
                    <span class="nf">PointFromScreen</span><span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">BottomRight</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">private</span> <span class="k">void</span> <span class="nf">Render</span><span class="p">(</span><span class="kt">double</span> <span class="n">progress</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">bounds</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">Left</span> <span class="p">-</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Left</span><span class="p">)</span> <span class="p">*</span> <span class="n">progress</span> <span class="p">+</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Left</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">Top</span> <span class="p">-</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Top</span><span class="p">)</span> <span class="p">*</span> <span class="n">progress</span> <span class="p">+</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Top</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">Width</span> <span class="p">-</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Width</span><span class="p">)</span> <span class="p">*</span> <span class="n">progress</span> <span class="p">+</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">_destinationBounds</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span> <span class="p">*</span> <span class="n">progress</span> <span class="p">+</span> <span class="n">_sourceBounds</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span>

                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dc</span> <span class="p">=</span> <span class="nf">RenderOpen</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">dc</span><span class="p">.</span><span class="nf">DrawRectangle</span><span class="p">(</span><span class="n">_sourceBrush</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">bounds</span><span class="p">);</span>
                    <span class="n">dc</span><span class="p">.</span><span class="nf">PushOpacity</span><span class="p">(</span><span class="n">progress</span><span class="p">);</span>
                    <span class="n">dc</span><span class="p">.</span><span class="nf">DrawRectangle</span><span class="p">(</span><span class="n">_destinationBrush</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">bounds</span><span class="p">);</span>
                    <span class="n">dc</span><span class="p">.</span><span class="nf">Pop</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">class</span> <span class="nc">ConnectedAnimationAdorner</span> <span class="p">:</span> <span class="n">Adorner</span>
        <span class="p">{</span>
            <span class="k">private</span> <span class="nf">ConnectedAnimationAdorner</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">UIElement</span> <span class="n">adornedElement</span><span class="p">)</span>
                <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">adornedElement</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Children</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">VisualCollection</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                <span class="n">IsHitTestVisible</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">internal</span> <span class="n">VisualCollection</span> <span class="n">Children</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

            <span class="k">protected</span> <span class="k">override</span> <span class="kt">int</span> <span class="n">VisualChildrenCount</span> <span class="p">=&gt;</span> <span class="n">Children</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span>

            <span class="k">protected</span> <span class="k">override</span> <span class="n">Visual</span> <span class="nf">GetVisualChild</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Children</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

            <span class="k">protected</span> <span class="k">override</span> <span class="n">Size</span> <span class="nf">ArrangeOverride</span><span class="p">(</span><span class="n">Size</span> <span class="n">finalSize</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">child</span> <span class="k">in</span> <span class="n">Children</span><span class="p">.</span><span class="n">OfType</span><span class="p">&lt;</span><span class="n">UIElement</span><span class="p">&gt;())</span>
                <span class="p">{</span>
                    <span class="n">child</span><span class="p">.</span><span class="nf">Arrange</span><span class="p">(</span><span class="k">new</span> <span class="nf">Rect</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">DesiredSize</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">finalSize</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">internal</span> <span class="k">static</span> <span class="n">ConnectedAnimationAdorner</span> <span class="nf">FindFrom</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">Visual</span> <span class="n">visual</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Window</span><span class="p">.</span><span class="nf">GetWindow</span><span class="p">(</span><span class="n">visual</span><span class="p">)?.</span><span class="n">Content</span> <span class="k">is</span> <span class="n">UIElement</span> <span class="n">root</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">layer</span> <span class="p">=</span> <span class="n">AdornerLayer</span><span class="p">.</span><span class="nf">GetAdornerLayer</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">layer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kt">var</span> <span class="n">adorner</span> <span class="p">=</span> <span class="n">layer</span><span class="p">.</span><span class="nf">GetAdorners</span><span class="p">(</span><span class="n">root</span><span class="p">)?.</span><span class="n">OfType</span><span class="p">&lt;</span><span class="n">ConnectedAnimationAdorner</span><span class="p">&gt;().</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">adorner</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">adorner</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConnectedAnimationAdorner</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
                            <span class="n">layer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">adorner</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="n">adorner</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"指定的 Visual 尚未连接到可见的视觉树中，找不到用于承载动画的容器。"</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">internal</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ClearFor</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="n">Visual</span> <span class="n">visual</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Window</span><span class="p">.</span><span class="nf">GetWindow</span><span class="p">(</span><span class="n">visual</span><span class="p">)?.</span><span class="n">Content</span> <span class="k">is</span> <span class="n">UIElement</span> <span class="n">root</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">layer</span> <span class="p">=</span> <span class="n">AdornerLayer</span><span class="p">.</span><span class="nf">GetAdornerLayer</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
                    <span class="kt">var</span> <span class="n">adorner</span> <span class="p">=</span> <span class="n">layer</span><span class="p">?.</span><span class="nf">GetAdorners</span><span class="p">(</span><span class="n">root</span><span class="p">)?.</span><span class="n">OfType</span><span class="p">&lt;</span><span class="n">ConnectedAnimationAdorner</span><span class="p">&gt;().</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">adorner</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">layer</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">adorner</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="调用">调用<a href="#调用"><i class="fas fa-hashtag"></i></a></h3></h3><p>我在一个按钮的点击事件里面尝试调用上面的代码：</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

<span class="k">private</span> <span class="k">void</span> <span class="nf">AnimationButton_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nf">BeginConnectedAnimation</span><span class="p">((</span><span class="n">UIElement</span><span class="p">)</span><span class="n">sender</span><span class="p">,</span> <span class="n">ConnectionDestination</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">BeginConnectedAnimation</span><span class="p">(</span><span class="n">UIElement</span> <span class="n">source</span><span class="p">,</span> <span class="n">UIElement</span> <span class="n">destination</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">service</span> <span class="p">=</span> <span class="n">ConnectedAnimationService</span><span class="p">.</span><span class="nf">GetForCurrentView</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">service</span><span class="p">.</span><span class="nf">PrepareToAnimate</span><span class="p">(</span><span class="s">$"Test</span><span class="p">{</span><span class="n">index</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>

    <span class="c1">// 这里特意写在了同一个方法中，以示效果。事实上，只要是同一个窗口中的两个对象都可以实现。</span>
    <span class="kt">var</span> <span class="n">animation</span> <span class="p">=</span> <span class="n">service</span><span class="p">.</span><span class="nf">GetAnimation</span><span class="p">(</span><span class="s">$"Test</span><span class="p">{</span><span class="n">index</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">animation</span><span class="p">?.</span><span class="nf">TryStart</span><span class="p">(</span><span class="n">destination</span><span class="p">);</span>

    <span class="c1">// 每次点击都使用不同的 Key。</span>
    <span class="n">index</span><span class="p">++;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/static/posts/2017-12-25-connected-animation-test.gif" alt="连接动画试验" /><br /> ▲ 上面的代码做的连接动画</p><h2 id="目前的局限性以及改进计划">目前的局限性以及改进计划<a href="#目前的局限性以及改进计划"><i class="fas fa-hashtag"></i></a></h2></h2><p>然而稍微试试不难发现，这段代码很难将控件本身隐藏起来（设置 <code class="language-plaintext highlighter-rouge">Visibility</code> 为 <code class="language-plaintext highlighter-rouge">Collapsed</code>），也就是说如果源控件和目标控件一直显示，那么动画期间就不允许隐藏（不同时显示就没有这个问题)。这样也就出不来“连接”的感觉，而是覆盖的感觉。</p><p>通过修改调用方的代码，可以规避这个问题。而做法是隐藏控件本身，但对控件内部的可视元素子级进行动画。这样，动画就仅限继承自 <code class="language-plaintext highlighter-rouge">Control</code> 的那些元素（例如 <code class="language-plaintext highlighter-rouge">Button</code>，<code class="language-plaintext highlighter-rouge">UserControl</code> 了）。</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">BeginConnectedAnimation</span><span class="p">(</span><span class="n">UIElement</span> <span class="n">source</span><span class="p">,</span> <span class="n">UIElement</span> <span class="n">destination</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">source</span><span class="p">.</span><span class="n">Visibility</span> <span class="p">=</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Hidden</span><span class="p">;</span>
    <span class="n">ConnectionDestination</span><span class="p">.</span><span class="n">Visibility</span> <span class="p">=</span> <span class="n">Visibility</span><span class="p">.</span><span class="n">Hidden</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">animatingSource</span> <span class="p">=</span> <span class="p">(</span><span class="n">UIElement</span><span class="p">)</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetChild</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">animatingDestination</span> <span class="p">=</span> <span class="p">(</span><span class="n">UIElement</span><span class="p">)</span> <span class="n">VisualTreeHelper</span><span class="p">.</span><span class="nf">GetChild</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">service</span> <span class="p">=</span> <span class="n">ConnectedAnimationService</span><span class="p">.</span><span class="nf">GetForCurrentView</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">service</span><span class="p">.</span><span class="nf">PrepareToAnimate</span><span class="p">(</span><span class="s">$"Test</span><span class="p">{</span><span class="n">index</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="n">animatingSource</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">animation</span> <span class="p">=</span> <span class="n">service</span><span class="p">.</span><span class="nf">GetAnimation</span><span class="p">(</span><span class="s">$"Test</span><span class="p">{</span><span class="n">index</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">animation</span><span class="p">?.</span><span class="nf">TryStart</span><span class="p">(</span><span class="n">animatingDestination</span><span class="p">);</span>
    <span class="n">index</span><span class="p">++;</span>

    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">600</span><span class="p">);</span>
    <span class="n">source</span><span class="p">.</span><span class="nf">ClearValue</span><span class="p">(</span><span class="n">VisibilityProperty</span><span class="p">);</span>
    <span class="n">ConnectionDestination</span><span class="p">.</span><span class="nf">ClearValue</span><span class="p">(</span><span class="n">VisibilityProperty</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/static/posts/2017-12-25-connected-animation-run.gif" alt="连接动画试验" /><br /> ▲ 修改后的代码做的连接动画</p><p>现在，我正试图通过截图和像素着色器（Shader Effect）来实现更加通用的 <code class="language-plaintext highlighter-rouge">ConnectedAnimation</code>，正在努力编写中……</p><hr /><p><strong>参考资料</strong></p><ul><li><a href="https://docs.microsoft.com/en-us/windows/uwp/design/motion/connected-animation?wt.mc_id=MVP">Connected animation - UWP app developer - Microsoft Docs</a><li><a href="http://varunshandilya.com/uwp-connected-animations-updates-with-windows-creators-release/">UWP Connected Animations updates with Windows Creators release – Varun Shandilya</a><li><a href="https://lijiaxiang98.github.io/2017/09/08/%E5%AE%9E%E7%8E%B0Fluent-Design%E4%B8%AD%E7%9A%84Connected-Animation/">实现 Fluent Design 中的 Connected Animation - ^ _ ^ .io</a></ul><p> 本文会经常更新，请阅读原文： <a href="/post/connected-animation-of-wpf.html">https://blog.walterlv.com/post/connected-animation-of-wpf.html</a> ，以避免陈旧错误知识的误导，同时有更好的阅读体验。</p><p> <a rel="知识共享许可协议" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="知识共享许可协议" src="https://blog.walterlv.com/assets/img/by-nc-sa.svg" /> </a></p><p> 本作品采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可。欢迎转载、使用、重新发布，但务必保留文章署名 吕毅 （包含链接： <a href="https://blog.walterlv.com">https://blog.walterlv.com</a> ），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。如有任何疑问，请 <a href="mailto:walter.lv@qq.com">与我联系 (walter.lv@qq.com)</a> 。</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="comments-wrapper"> 登录 GitHub 账号进行评论</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=实现一个 WPF 版本的 ConnectedAnimation - walterlv&url=https://blog.walterlv.com/post/connected-animation-of-wpf.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=实现一个 WPF 版本的 ConnectedAnimation - walterlv&u=https://blog.walterlv.com/post/connected-animation-of-wpf.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=实现一个 WPF 版本的 ConnectedAnimation - walterlv&url=https://blog.walterlv.com/post/connected-animation-of-wpf.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/post/monitor-foreground-window-on-windows">如何在控制台程序中监听 Windows 前台窗口的变化</a><li><a href="/post/how-to-start-a-process-with-environment-variables-without-code">在 Windows 上如何在启动程序时单独为这个程序指定环境变量，而不需要编写任何代码或脚本</a><li><a href="/post/wpf-draw-a-hsl-hsb-palette-using-hlsl">WPF 像素着色器进阶：使用 HLSL 编写一个高性能的实时变化的 HSL/HSV/HSB 调色盘</a><li><a href="/post/create-wpf-pixel-shader-effects-using-shazzam-shader-editor.html">WPF 像素着色器入门：使用 Shazzam Shader Editor 编写 HLSL 像素着色器代码</a><li><a href="/post/where-is-the-windows-10-native-icons.html">Windows 10 自带那么多图标，去哪里找呢？</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><section class="comments"> <script src="https://utteranc.es/client.js" repo="walterlv/BlogComments" issue-term="pathname" theme="preferred-color-scheme" crossorigin="anonymous" async> </script></section></div></div></div><footer class="d-flex flex-column w-100 justify-content-center"><div id="analytics-box"> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-108101550-1"></script> <script> document.addEventListener("DOMContentLoaded", function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-108101550-1'); }); </script> <script async type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1264408226'%3E%3C/span%3E%3Cscript src='//s22.cnzz.com/z_stat.php%3Fid%3D1264408226%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2014-2024 <a href="https://github.com/walterlv">walterlv</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由吕毅按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，基于 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题修改。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/csharp/">csharp</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wpf/">wpf</a> <a class="post-tag" href="/tags/visualstudio/">visualstudio</a> <a class="post-tag" href="/tags/msbuild/">msbuild</a> <a class="post-tag" href="/tags/uwp/">uwp</a> <a class="post-tag" href="/tags/nuget/">nuget</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/roslyn/">roslyn</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
